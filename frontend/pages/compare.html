<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>对比测试 - LLM Test Tool</title>
    <script src="/assets/vendor/vue/vue.global.js"></script>
    <script src="/assets/vendor/tailwind/tailwind.js"></script>
    <link rel="stylesheet" href="/assets/vendor/fontawesome/all.min.css">
    <link rel="stylesheet" href="/assets/css/style.css">
</head>
<body class="bg-gray-50">
    <div id="app" v-cloak>
        <!-- 导航栏 -->
        <nav class="bg-white shadow-lg">
            <div class="max-w-7xl mx-auto px-4">
                <div class="flex justify-between items-center h-16">
                    <div class="flex items-center space-x-2">
                        <i class="fas fa-robot text-2xl text-blue-600"></i>
                        <span class="text-xl font-bold text-gray-800">LLM Test Tool</span>
                    </div>
                    <div class="flex space-x-4">
                        <a href="/" class="px-4 py-2 rounded-md text-gray-600 hover:bg-gray-100">
                            <i class="fas fa-home mr-2"></i>首页
                        </a>
                        <a href="/pages/models.html" class="px-4 py-2 rounded-md text-gray-600 hover:bg-gray-100">
                            <i class="fas fa-cog mr-2"></i>模型配置
                        </a>
                        <a href="/pages/testcases.html" class="px-4 py-2 rounded-md text-gray-600 hover:bg-gray-100">
                            <i class="fas fa-tasks mr-2"></i>测试用例
                        </a>
                        <a href="/pages/tools.html" class="px-4 py-2 rounded-md text-gray-600 hover:bg-gray-100">
                            <i class="fas fa-wrench mr-2"></i>工具管理
                        </a>
                        <a href="/pages/system_prompts.html" class="px-4 py-2 rounded-md text-gray-600 hover:bg-gray-100">
                            <i class="fas fa-comment-dots mr-2"></i>系统提示词
                        </a>
                        <a href="/pages/debug.html" class="px-4 py-2 rounded-md text-gray-600 hover:bg-gray-100">
                            <i class="fas fa-bug mr-2"></i>调试
                        </a>
                        <a href="/pages/compare.html" class="px-4 py-2 rounded-md bg-blue-100 text-blue-700">
                            <i class="fas fa-code-compare mr-2"></i>对比测试
                        </a>
                    </div>
                </div>
            </div>
        </nav>

        <main class="max-w-7xl mx-auto px-4 py-8">
            <h1 class="text-3xl font-bold text-gray-800 mb-6">
                <i class="fas fa-code-compare mr-2 text-orange-600"></i>多模型对比测试
            </h1>

            <!-- 配置面板 -->
            <div class="bg-white rounded-lg shadow-md p-6 mb-6">
                <h2 class="text-xl font-bold text-gray-800 mb-4">测试配置</h2>
                
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                    <!-- 选择模型 -->
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-3">选择模型 (可多选)</label>
                        <div class="border rounded-lg p-4 max-h-64 overflow-y-auto space-y-2">
                            <label v-for="model in models" :key="model.id" 
                                   class="flex items-center p-2 hover:bg-gray-50 rounded cursor-pointer">
                                <input type="checkbox" :value="model.id" v-model="selectedModels" class="mr-3">
                                <div class="flex-1">
                                    <div class="font-semibold">{{ model.name }}</div>
                                    <div class="text-sm text-gray-500">{{ model.model_name }}</div>
                                </div>
                                <span class="px-2 py-1 text-xs rounded"
                                      :class="getProviderClass(model.provider)">
                                    {{ getProviderLabel(model.provider) }}
                                </span>
                            </label>
                            <div v-if="models.length === 0" class="text-gray-500 text-center py-4">
                                暂无可用模型，请先配置模型
                            </div>
                        </div>
                    </div>

                    <!-- 选择测试用例 -->
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-3">选择测试用例 (可多选)</label>
                        <div class="border rounded-lg p-4 max-h-64 overflow-y-auto space-y-2">
                            <label v-for="testCase in testCases" :key="testCase.id" 
                                   class="flex items-center p-2 hover:bg-gray-50 rounded cursor-pointer">
                                <input type="checkbox" :value="testCase.id" v-model="selectedTestCases" class="mr-3">
                                <div class="flex-1">
                                    <div class="font-semibold">{{ testCase.title }}</div>
                                    <div class="text-sm text-gray-500 truncate">
                                        {{ testCase.prompt.substring(0, 60) }}...
                                    </div>
                                </div>
                            </label>
                            <div v-if="testCases.length === 0" class="text-gray-500 text-center py-4">
                                暂无测试用例，请先创建测试用例
                            </div>
                        </div>
                    </div>
                </div>

                <div class="mt-6 flex justify-between items-center">
                    <div class="text-sm text-gray-600">
                        已选择 <strong>{{ selectedModels.length }}</strong> 个模型 和 
                        <strong>{{ selectedTestCases.length }}</strong> 个测试用例
                        （共 <strong>{{ selectedModels.length * selectedTestCases.length }}</strong> 次测试）
                    </div>
                    <div class="flex space-x-3">
                        <button @click="showHistoryModal = true; loadHistoryList()" 
                                class="bg-gray-600 text-white px-6 py-3 rounded-lg hover:bg-gray-700">
                            <i class="fas fa-history mr-2"></i>
                            查看历史测试
                        </button>
                        <button @click="runBatchTest" 
                                :disabled="selectedModels.length === 0 || selectedTestCases.length === 0 || running"
                                class="bg-orange-600 text-white px-8 py-3 rounded-lg hover:bg-orange-700 disabled:opacity-50 disabled:cursor-not-allowed">
                            <i class="fas fa-play mr-2"></i>
                            {{ running ? '测试中...' : '开始批量测试' }}
                        </button>
                    </div>
                </div>
            </div>

            <!-- 测试进度 -->
            <div v-if="running" class="bg-white rounded-lg shadow-md p-6 mb-6">
                <div class="flex items-center justify-between mb-4">
                    <h3 class="text-lg font-bold text-gray-800">测试进度</h3>
                    <span class="text-sm text-gray-600">{{ batchId }}</span>
                </div>
                <div class="w-full bg-gray-200 rounded-full h-4">
                    <div class="bg-blue-600 h-4 rounded-full transition-all" 
                         :style="{width: progress + '%'}"></div>
                </div>
                <p class="mt-2 text-sm text-gray-600 text-center">
                    正在执行批量测试，请稍候...
                </p>
            </div>

            <!-- 对比结果 -->
            <div v-if="compareResults.length > 0" class="space-y-6">
                <div class="flex justify-between items-center">
                    <h2 class="text-2xl font-bold text-gray-800">对比结果</h2>
                    <button @click="exportResults" class="bg-green-600 text-white px-6 py-2 rounded-lg hover:bg-green-700">
                        <i class="fas fa-download mr-2"></i>导出结果
                    </button>
                </div>

                <!-- 每个测试用例的结果 -->
                <div v-for="result in compareResults" :key="result.test_case_id" 
                     class="bg-white rounded-lg shadow-md overflow-hidden">
                    <div class="bg-gradient-to-r from-blue-500 to-purple-600 p-4">
                        <h3 class="text-xl font-bold text-white">{{ result.test_case_title }}</h3>
                    </div>

                    <!-- 对比表格 -->
                    <div class="overflow-x-auto">
                        <table class="w-full">
                            <thead class="bg-gray-50">
                                <tr>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">模型</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">输出</th>
                                    <th class="px-6 py-3 text-center text-xs font-medium text-gray-500 uppercase">评分</th>
                                    <th class="px-6 py-3 text-center text-xs font-medium text-gray-500 uppercase">响应时间</th>
                                    <th class="px-6 py-3 text-center text-xs font-medium text-gray-500 uppercase">Tokens</th>
                                    <th class="px-6 py-3 text-center text-xs font-medium text-gray-500 uppercase">成本</th>
                                    <th class="px-6 py-3 text-center text-xs font-medium text-gray-500 uppercase">状态</th>
                                    <th class="px-6 py-3 text-center text-xs font-medium text-gray-500 uppercase">操作</th>
                                </tr>
                            </thead>
                            <tbody class="divide-y divide-gray-200">
                                <tr v-for="modelResult in result.results" :key="modelResult.result_id"
                                    class="hover:bg-gray-50">
                                    <td class="px-6 py-4">
                                        <div class="font-semibold text-gray-800">{{ modelResult.model_name }}</div>
                                    </td>
                                    <td class="px-6 py-4">
                                        <div class="max-w-md">
                                            <p class="text-sm text-gray-700 line-clamp-3">
                                                {{ modelResult.output }}
                                            </p>
                                            <button @click="showFullOutput(modelResult)" 
                                                    class="text-blue-600 text-xs mt-1 hover:underline">
                                                查看完整输出
                                            </button>
                                        </div>
                                    </td>
                                    <td class="px-6 py-4 text-center">
                                        <div v-if="modelResult.score !== null && modelResult.score !== undefined">
                                            <div class="text-lg font-bold" 
                                                 :class="getScoreColor(modelResult.score)">
                                                {{ (modelResult.score * 100).toFixed(0) }}%
                                            </div>
                                            <button v-if="modelResult.metrics?.evaluation" 
                                                    @click="showEvaluationDetails(modelResult)"
                                                    class="text-xs text-blue-600 hover:underline mt-1">
                                                查看详情
                                            </button>
                                        </div>
                                        <span v-else class="text-gray-400 text-sm">未评分</span>
                                    </td>
                                    <td class="px-6 py-4 text-center">
                                        <span class="font-semibold">
                                            {{ modelResult.metrics.response_time?.toFixed(2) }}s
                                        </span>
                                    </td>
                                    <td class="px-6 py-4 text-center">
                                        <span class="font-semibold">
                                            {{ modelResult.metrics.total_tokens || 'N/A' }}
                                        </span>
                                    </td>
                                    <td class="px-6 py-4 text-center">
                                        <span class="font-semibold text-green-600">
                                            ${{ modelResult.metrics.estimated_cost?.toFixed(4) || '0.00' }}
                                        </span>
                                    </td>
                                    <td class="px-6 py-4 text-center">
                                        <span class="px-3 py-1 rounded-full text-xs font-semibold"
                                              :class="modelResult.status === 'success' ? 'bg-green-100 text-green-800' : 'bg-red-100 text-red-800'">
                                            {{ modelResult.status === 'success' ? '成功' : '失败' }}
                                        </span>
                                    </td>
                                    <td class="px-6 py-4 text-center">
                                        <button @click="deleteResult(modelResult.result_id)" 
                                                class="text-red-600 hover:text-red-800 hover:bg-red-50 p-2 rounded"
                                                title="删除此结果">
                                            <i class="fas fa-trash"></i>
                                        </button>
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>

                    <!-- 性能对比图表 -->
                    <div class="p-6 bg-gray-50">
                        <h4 class="font-bold text-gray-800 mb-4">性能对比</h4>
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                            <div v-for="metric in ['response_time', 'total_tokens', 'estimated_cost']" 
                                 :key="metric"
                                 class="bg-white rounded p-4">
                                <div class="text-sm text-gray-600 mb-2">{{ getMetricLabel(metric) }}</div>
                                <div v-for="modelResult in result.results" :key="modelResult.model_id"
                                     class="flex items-center mb-2">
                                    <span class="text-xs w-24 truncate">{{ modelResult.model_name }}</span>
                                    <div class="flex-1 mx-2 bg-gray-200 rounded h-4">
                                        <div class="bg-blue-500 h-4 rounded"
                                             :style="{width: getBarWidth(modelResult.metrics[metric], result.results, metric) + '%'}">
                                        </div>
                                    </div>
                                    <span class="text-xs font-semibold">
                                        {{ formatMetricValue(modelResult.metrics[metric], metric) }}
                                    </span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- 完整输出弹窗 -->
            <div v-if="showOutputModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
                <div class="bg-white rounded-lg shadow-xl w-full max-w-4xl max-h-screen overflow-y-auto m-4">
                    <div class="p-6 border-b flex justify-between items-center">
                        <h2 class="text-2xl font-bold text-gray-800">{{ currentOutput?.model_name }} - 完整输出</h2>
                        <button @click="showOutputModal = false" class="text-gray-500 hover:text-gray-700">
                            <i class="fas fa-times text-2xl"></i>
                        </button>
                    </div>
                    <div class="p-6 space-y-4">
                        <!-- 文本输出 -->
                        <div v-if="currentOutput?.output">
                            <h3 class="text-sm font-semibold text-gray-700 mb-2">
                                <i class="fas fa-comment-dots mr-1"></i>文本输出
                            </h3>
                            <pre class="whitespace-pre-wrap text-sm text-gray-700 bg-gray-50 p-4 rounded border">{{ currentOutput.output }}</pre>
                        </div>
                        
                        <!-- 工具调用 -->
                        <div v-if="currentOutput?.tool_calls && currentOutput.tool_calls.length > 0">
                            <h3 class="text-sm font-semibold text-gray-700 mb-2">
                                <i class="fas fa-wrench mr-1 text-yellow-600"></i>工具调用
                            </h3>
                            <div class="space-y-3">
                                <div v-for="(call, idx) in currentOutput.tool_calls" :key="idx"
                                     class="bg-yellow-50 border border-yellow-200 rounded-lg p-4">
                                    <div class="flex items-start justify-between mb-2">
                                        <div>
                                            <span class="font-semibold text-yellow-800 font-mono">
                                                {{ call.function ? call.function.name : call.name }}
                                            </span>
                                            <span class="text-xs text-gray-500 ml-2">{{ call.type || 'function' }}</span>
                                        </div>
                                        <span v-if="call.id" class="text-xs text-gray-400 font-mono">{{ call.id }}</span>
                                    </div>
                                    <div class="text-sm">
                                        <div class="font-medium text-gray-700 mb-1">参数:</div>
                                        <pre class="bg-white p-3 rounded text-xs font-mono overflow-x-auto border">{{ formatToolCallArguments(call) }}</pre>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- 无输出提示 -->
                        <div v-if="!currentOutput?.output && (!currentOutput?.tool_calls || currentOutput.tool_calls.length === 0)"
                             class="text-gray-400 italic text-center py-8">
                            <i class="fas fa-inbox text-4xl mb-2"></i>
                            <p>无输出内容</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- 评估详情弹窗 -->
            <div v-if="showEvalModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
                <div class="bg-white rounded-lg shadow-xl w-full max-w-4xl max-h-screen overflow-y-auto m-4">
                    <div class="p-6 border-b flex justify-between items-center">
                        <h2 class="text-2xl font-bold text-gray-800">
                            <i class="fas fa-chart-line mr-2 text-blue-600"></i>
                            {{ currentEvaluation?.model_name }} - 评估详情
                        </h2>
                        <button @click="showEvalModal = false" class="text-gray-500 hover:text-gray-700">
                            <i class="fas fa-times text-2xl"></i>
                        </button>
                    </div>
                    <div class="p-6 space-y-6" v-if="currentEvaluation?.metrics?.evaluation">
                        <!-- Overall Score with Breakdown -->
                        <div class="bg-gradient-to-r from-blue-50 to-indigo-50 rounded-lg p-6">
                            <div class="text-center mb-4">
                                <div class="text-sm text-gray-600 mb-2">总体评分</div>
                                <div class="text-5xl font-bold" :class="getScoreColor(currentEvaluation.score)">
                                    {{ (currentEvaluation.score * 100).toFixed(0) }}%
                                </div>
                            </div>
                            
                            <!-- Score Breakdown -->
                            <div class="mt-4 pt-4 border-t border-blue-200">
                                <div class="text-xs text-gray-600 mb-3 text-center font-semibold">评分构成（加权计算）</div>
                                <div class="space-y-2">
                                    <!-- Tool Calls Score -->
                                    <div v-if="currentEvaluation.metrics.evaluation.tool_calls" 
                                         class="flex items-center justify-between text-sm">
                                        <div class="flex items-center">
                                            <i class="fas fa-wrench text-orange-600 mr-2"></i>
                                            <span class="text-gray-700">工具调用</span>
                                            <span class="text-xs text-gray-500 ml-2">
                                                (权重 {{ getActualWeight('tool_call') }}%)
                                            </span>
                                        </div>
                                        <div class="flex items-center space-x-2">
                                            <span class="text-gray-600 font-mono text-xs">
                                                {{ calculateToolCallScore(currentEvaluation.metrics.evaluation.tool_calls).toFixed(1) }}%
                                            </span>
                                            <span class="text-gray-400">×</span>
                                            <span class="text-gray-500 text-xs">{{ (getActualWeight('tool_call') / 100).toFixed(2) }}</span>
                                            <span class="text-gray-400">=</span>
                                            <span class="font-semibold text-blue-600">
                                                {{ (calculateToolCallScore(currentEvaluation.metrics.evaluation.tool_calls) * getActualWeight('tool_call') / 100).toFixed(1) }}%
                                            </span>
                                        </div>
                                    </div>
                                    
                                    <!-- Text Similarity Score -->
                                    <div v-if="currentEvaluation.metrics.evaluation.text_similarity !== undefined" 
                                         class="flex items-center justify-between text-sm">
                                        <div class="flex items-center">
                                            <i class="fas fa-align-left text-purple-600 mr-2"></i>
                                            <span class="text-gray-700">文本相似度</span>
                                            <span class="text-xs text-gray-500 ml-2">
                                                (权重 {{ getActualWeight('text_similarity') }}%)
                                            </span>
                                        </div>
                                        <div class="flex items-center space-x-2">
                                            <span class="text-gray-600 font-mono text-xs">
                                                {{ (formatScore(currentEvaluation.metrics.evaluation.text_similarity) * 5).toFixed(1) }}%
                                            </span>
                                            <span class="text-gray-400">×</span>
                                            <span class="text-gray-500 text-xs">{{ (getActualWeight('text_similarity') / 100).toFixed(2) }}</span>
                                            <span class="text-gray-400">=</span>
                                            <span class="font-semibold text-purple-600">
                                                {{ (formatScore(currentEvaluation.metrics.evaluation.text_similarity) * 5 * getActualWeight('text_similarity') / 100).toFixed(1) }}%
                                            </span>
                                        </div>
                                    </div>
                                    
                                    <!-- Custom Criteria Score -->
                                    <div v-if="currentEvaluation.metrics.evaluation.custom_criteria !== undefined" 
                                         class="flex items-center justify-between text-sm">
                                        <div class="flex items-center">
                                            <i class="fas fa-clipboard-check text-teal-600 mr-2"></i>
                                            <span class="text-gray-700">自定义标准</span>
                                            <span class="text-xs text-gray-500 ml-2">
                                                (权重 {{ getActualWeight('custom') }}%)
                                            </span>
                                        </div>
                                        <div class="flex items-center space-x-2">
                                            <span class="text-gray-600 font-mono text-xs">
                                                {{ (formatScore(currentEvaluation.metrics.evaluation.custom_criteria) * 10).toFixed(1) }}%
                                            </span>
                                            <span class="text-gray-400">×</span>
                                            <span class="text-gray-500 text-xs">{{ (getActualWeight('custom') / 100).toFixed(2) }}</span>
                                            <span class="text-gray-400">=</span>
                                            <span class="font-semibold text-teal-600">
                                                {{ (formatScore(currentEvaluation.metrics.evaluation.custom_criteria) * 10 * getActualWeight('custom') / 100).toFixed(1) }}%
                                            </span>
                                        </div>
                                    </div>
                                    
                                    <!-- Total -->
                                    <div class="flex items-center justify-between text-sm pt-2 border-t border-blue-200">
                                        <span class="text-gray-800 font-semibold">总计</span>
                                        <div class="flex items-center space-x-2">
                                            <span class="text-lg font-bold" :class="getScoreColor(currentEvaluation.score)">
                                                {{ (currentEvaluation.score * 100).toFixed(1) }}%
                                            </span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Output Comparison Section -->
                        <div class="border rounded-lg p-4 bg-gradient-to-r from-gray-50 to-slate-50">
                            <h3 class="font-bold text-gray-800 mb-4 flex items-center">
                                <i class="fas fa-code-compare text-indigo-600 mr-2"></i>
                                输出对比
                            </h3>
                            <div class="grid grid-cols-2 gap-4">
                                <!-- Expected Output -->
                                <div class="border rounded-lg bg-white">
                                    <div class="bg-green-100 px-4 py-2 border-b rounded-t-lg">
                                        <h4 class="text-sm font-semibold text-green-800 flex items-center">
                                            <i class="fas fa-bullseye mr-2"></i>期望输出
                                        </h4>
                                    </div>
                                    <div class="p-4">
                                        <div v-if="currentEvaluation.testCaseInfo?.expected_output" 
                                             class="text-sm text-gray-700 whitespace-pre-wrap max-h-60 overflow-y-auto">
                                            {{ currentEvaluation.testCaseInfo.expected_output }}
                                        </div>
                                        <div v-else class="text-sm text-gray-400 italic text-center py-4">
                                            未设置期望输出
                                        </div>
                                    </div>
                                </div>

                                <!-- Actual Output -->
                                <div class="border rounded-lg bg-white">
                                    <div class="bg-blue-100 px-4 py-2 border-b rounded-t-lg">
                                        <h4 class="text-sm font-semibold text-blue-800 flex items-center">
                                            <i class="fas fa-robot mr-2"></i>实际输出 ({{ currentEvaluation.model_name }})
                                        </h4>
                                    </div>
                                    <div class="p-4">
                                        <div v-if="currentEvaluation.output && !currentEvaluation.output.startsWith('[模型调用了')" 
                                             class="text-sm text-gray-700 whitespace-pre-wrap max-h-60 overflow-y-auto">
                                            {{ currentEvaluation.output }}
                                        </div>
                                        <div v-else-if="currentEvaluation.output && currentEvaluation.output.startsWith('[模型调用了')"
                                             class="text-sm text-gray-500 italic text-center py-4">
                                            {{ currentEvaluation.output }}
                                            <div class="mt-2 text-xs text-gray-400">
                                                (工具调用详情见下方)
                                            </div>
                                        </div>
                                        <div v-else class="text-sm text-gray-400 italic text-center py-4">
                                            无文本输出
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Prompt Display (Collapsible) -->
                            <div class="mt-4 pt-4 border-t">
                                <details class="cursor-pointer">
                                    <summary class="text-sm font-semibold text-gray-700 hover:text-gray-900 flex items-center">
                                        <i class="fas fa-comment-dots mr-2 text-gray-500"></i>
                                        查看测试提示词
                                    </summary>
                                    <div class="mt-3 p-3 bg-gray-100 rounded text-sm text-gray-700 whitespace-pre-wrap">
                                        {{ currentEvaluation.testCaseInfo?.test_case_prompt || '无提示词' }}
                                    </div>
                                </details>
                            </div>
                        </div>

                        <!-- Tool Calls Evaluation -->
                        <div v-if="currentEvaluation.metrics.evaluation.tool_calls" 
                             class="border rounded-lg p-4">
                            <h3 class="font-bold text-gray-800 mb-4 flex items-center">
                                <i class="fas fa-wrench text-orange-600 mr-2"></i>
                                工具调用评估
                            </h3>
                            <div class="space-y-3">
                                <div class="flex justify-between items-center p-3 bg-gray-50 rounded">
                                    <span class="text-sm text-gray-700">名称匹配</span>
                                    <span class="font-bold" :class="getScoreColor(formatScore(currentEvaluation.metrics.evaluation.tool_calls.name_match) / 20)">
                                        {{ formatScore(currentEvaluation.metrics.evaluation.tool_calls.name_match) }} / 20
                                    </span>
                                </div>
                                <div class="flex justify-between items-center p-3 bg-gray-50 rounded">
                                    <span class="text-sm text-gray-700">数量匹配</span>
                                    <span class="font-bold" :class="getScoreColor(formatScore(currentEvaluation.metrics.evaluation.tool_calls.count_match) / 20)">
                                        {{ formatScore(currentEvaluation.metrics.evaluation.tool_calls.count_match) }} / 20
                                    </span>
                                </div>
                                <div class="flex justify-between items-center p-3 bg-gray-50 rounded">
                                    <span class="text-sm text-gray-700">参数名称匹配</span>
                                    <span class="font-bold" :class="getScoreColor(formatScore(currentEvaluation.metrics.evaluation.tool_calls.params_match) / 30)">
                                        {{ formatScore(currentEvaluation.metrics.evaluation.tool_calls.params_match) }} / 30
                                    </span>
                                </div>
                                <div class="flex justify-between items-center p-3 bg-gray-50 rounded">
                                    <span class="text-sm text-gray-700">参数值匹配</span>
                                    <span class="font-bold" :class="getScoreColor(formatScore(currentEvaluation.metrics.evaluation.tool_calls.values_match) / 30)">
                                        {{ formatScore(currentEvaluation.metrics.evaluation.tool_calls.values_match) }} / 30
                                    </span>
                                </div>
                                
                                <!-- Expected vs Actual Comparison -->
                                <div class="mt-4 pt-4 border-t">
                                    <div class="grid grid-cols-2 gap-4">
                                        <div>
                                            <h4 class="text-sm font-semibold text-green-700 mb-2">期望的工具调用</h4>
                                            <div v-if="currentEvaluation.metrics.evaluation.tool_calls.expected && currentEvaluation.metrics.evaluation.tool_calls.expected.length > 0"
                                                 class="space-y-2">
                                                <div v-for="(call, idx) in currentEvaluation.metrics.evaluation.tool_calls.expected" 
                                                     :key="idx"
                                                     class="bg-green-50 border border-green-200 rounded p-2 text-sm">
                                                    <div class="font-mono font-semibold text-green-800">{{ call.name }}</div>
                                                    <pre class="text-xs text-gray-600 mt-1 whitespace-pre-wrap">{{ JSON.stringify(call.arguments, null, 2) }}</pre>
                                                </div>
                                            </div>
                                            <div v-else class="text-sm text-gray-500 italic">未设置期望</div>
                                        </div>
                                        <div>
                                            <h4 class="text-sm font-semibold text-blue-700 mb-2">实际的工具调用</h4>
                                            <div v-if="currentEvaluation.metrics.evaluation.tool_calls.actual && currentEvaluation.metrics.evaluation.tool_calls.actual.length > 0"
                                                 class="space-y-2">
                                                <div v-for="(call, idx) in currentEvaluation.metrics.evaluation.tool_calls.actual" 
                                                     :key="idx"
                                                     class="bg-blue-50 border border-blue-200 rounded p-2 text-sm">
                                                    <div class="font-mono font-semibold text-blue-800">{{ call.name }}</div>
                                                    <pre class="text-xs text-gray-600 mt-1 whitespace-pre-wrap">{{ JSON.stringify(call.arguments, null, 2) }}</pre>
                                                </div>
                                            </div>
                                            <div v-else class="text-sm text-gray-500 italic">无工具调用</div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Text Similarity -->
                        <div v-if="currentEvaluation.metrics.evaluation.text_similarity !== undefined" 
                             class="border rounded-lg p-4">
                            <h3 class="font-bold text-gray-800 mb-3 flex items-center">
                                <i class="fas fa-align-left text-purple-600 mr-2"></i>
                                文本相似度
                            </h3>
                            <div class="flex justify-between items-center p-3 bg-gray-50 rounded">
                                <span class="text-sm text-gray-700">相似度得分</span>
                                <span class="font-bold" :class="getScoreColor(formatScore(currentEvaluation.metrics.evaluation.text_similarity) / 20)">
                                    {{ formatScore(currentEvaluation.metrics.evaluation.text_similarity) }} / 20
                                </span>
                            </div>
                        </div>

                        <!-- Custom Criteria -->
                        <div v-if="currentEvaluation.metrics.evaluation.custom_criteria !== undefined" 
                             class="border rounded-lg p-4">
                            <h3 class="font-bold text-gray-800 mb-3 flex items-center">
                                <i class="fas fa-clipboard-check text-teal-600 mr-2"></i>
                                自定义标准
                            </h3>
                            <div class="flex justify-between items-center p-3 bg-gray-50 rounded">
                                <span class="text-sm text-gray-700">自定义得分</span>
                                <span class="font-bold" :class="getScoreColor(formatScore(currentEvaluation.metrics.evaluation.custom_criteria) / 10)">
                                    {{ formatScore(currentEvaluation.metrics.evaluation.custom_criteria) }} / 10
                                </span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- 历史测试弹窗 -->
            <div v-if="showHistoryModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
                <div class="bg-white rounded-lg shadow-xl w-full max-w-5xl max-h-screen overflow-y-auto m-4">
                    <div class="p-6 border-b flex justify-between items-center bg-gradient-to-r from-gray-50 to-blue-50">
                        <h2 class="text-2xl font-bold text-gray-800">
                            <i class="fas fa-history mr-2 text-blue-600"></i>
                            批量测试历史
                        </h2>
                        <button @click="showHistoryModal = false" class="text-gray-500 hover:text-gray-700">
                            <i class="fas fa-times text-2xl"></i>
                        </button>
                    </div>
                    <div class="p-6">
                        <div v-if="loadingHistory" class="text-center py-8">
                            <i class="fas fa-spinner fa-spin text-4xl text-gray-400 mb-3"></i>
                            <p class="text-gray-600">加载历史记录中...</p>
                        </div>
                        
                        <div v-else-if="batchHistory.length === 0" class="text-center py-12">
                            <i class="fas fa-inbox text-6xl text-gray-300 mb-4"></i>
                            <p class="text-gray-500 text-lg">暂无历史测试记录</p>
                            <p class="text-gray-400 text-sm mt-2">执行批量测试后将显示在这里</p>
                        </div>
                        
                        <div v-else class="space-y-3">
                            <div v-for="batch in batchHistory" :key="batch.batch_id"
                                 class="border rounded-lg hover:shadow-md transition-shadow bg-white overflow-hidden">
                                <div class="p-4 cursor-pointer hover:bg-gray-50" @click="loadBatchHistory(batch)">
                                    <div class="flex justify-between items-start">
                                        <div class="flex-1">
                                            <div class="flex items-center space-x-3 mb-2">
                                                <span class="font-mono text-sm font-semibold text-gray-800">
                                                    {{ batch.batch_id }}
                                                </span>
                                                <span class="px-2 py-1 bg-blue-100 text-blue-800 text-xs font-semibold rounded">
                                                    {{ batch.total_tests }} 次测试
                                                </span>
                                            </div>
                                            <div class="text-sm text-gray-600 mb-2">
                                                <i class="far fa-clock mr-1"></i>
                                                {{ formatTimestamp(batch.timestamp) }}
                                            </div>
                                            <div class="flex space-x-4 text-xs">
                                                <div>
                                                    <i class="fas fa-robot mr-1 text-green-600"></i>
                                                    <span class="text-gray-600">
                                                        模型: {{ batch.models.map(m => m.name).join(', ') }}
                                                    </span>
                                                </div>
                                                <div>
                                                    <i class="fas fa-tasks mr-1 text-purple-600"></i>
                                                    <span class="text-gray-600">
                                                        用例: {{ batch.test_cases.map(tc => tc.title).join(', ') }}
                                                    </span>
                                                </div>
                                            </div>
                                        </div>
                                        <div class="flex items-center space-x-2 ml-4">
                                            <button @click.stop="loadBatchHistory(batch)" 
                                                    class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 text-sm">
                                                <i class="fas fa-eye mr-1"></i>
                                                查看
                                            </button>
                                            <button @click.stop="deleteBatch(batch.batch_id)" 
                                                    class="px-3 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700 text-sm"
                                                    title="删除此批次">
                                                <i class="fas fa-trash"></i>
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <script src="/assets/js/utils/api.js"></script>
    <script>
        const { createApp } = Vue;

        createApp({
            data() {
                return {
                    models: [],
                    testCases: [],
                    selectedModels: [],
                    selectedTestCases: [],
                    running: false,
                    batchId: '',
                    progress: 0,
                    compareResults: [],
                    showOutputModal: false,
                    currentOutput: null,
                    showEvalModal: false,
                    currentEvaluation: null,
                    showHistoryModal: false,
                    batchHistory: [],
                    loadingHistory: false
                }
            },
            async mounted() {
                await this.loadModels();
                await this.loadTestCases();
            },
            methods: {
                async loadModels() {
                    try {
                        this.models = await api.get('/api/models');
                    } catch (error) {
                        alert('加载模型失败: ' + error.message);
                    }
                },
                async loadTestCases() {
                    try {
                        this.testCases = await api.get('/api/testcases');
                    } catch (error) {
                        alert('加载测试用例失败: ' + error.message);
                    }
                },
                async runBatchTest() {
                    this.running = true;
                    this.progress = 0;
                    this.compareResults = [];

                    try {
                        const response = await api.post('/api/batch/run', {
                            model_ids: this.selectedModels,
                            test_case_ids: this.selectedTestCases
                        });

                        this.batchId = response.batch_id;

                        // 轮询结果
                        await this.pollResults();
                    } catch (error) {
                        alert('启动批量测试失败: ' + error.message);
                        this.running = false;
                    }
                },
                async pollResults() {
                    const maxAttempts = 60;
                    let attempts = 0;

                    const poll = async () => {
                        attempts++;
                        this.progress = Math.min(95, (attempts / maxAttempts) * 100);

                        try {
                            const results = await api.get(`/api/batch/results/${this.batchId}`);
                            
                            // 检查是否完成
                            if (results.results && results.results.length > 0) {
                                await this.loadCompareResults();
                                this.running = false;
                                this.progress = 100;
                                return;
                            }
                        } catch (error) {
                            // 继续轮询
                        }

                        if (attempts < maxAttempts) {
                            setTimeout(poll, 2000);
                        } else {
                            // 超时，尝试加载结果
                            await this.loadCompareResults();
                            this.running = false;
                        }
                    };

                    await poll();
                },
                async loadCompareResults() {
                    try {
                        this.compareResults = await api.get('/api/batch/compare', {
                            model_ids: this.selectedModels.join(','),
                            test_case_ids: this.selectedTestCases.join(',')
                        });
                    } catch (error) {
                        console.error('加载对比结果失败:', error);
                    }
                },
                async deleteResult(resultId) {
                    if (!confirm('确定要删除这条测试结果吗？')) {
                        return;
                    }
                    
                    try {
                        await api.delete(`/api/batch/results/${resultId}`);
                        alert('删除成功！');
                        // 重新加载对比结果
                        await this.loadCompareResults();
                    } catch (error) {
                        alert('删除失败: ' + error.message);
                    }
                },
                showFullOutput(modelResult) {
                    // 从 metrics 中提取工具调用信息
                    let toolCalls = null;
                    if (modelResult.metrics && modelResult.metrics.evaluation && 
                        modelResult.metrics.evaluation.tool_calls && 
                        modelResult.metrics.evaluation.tool_calls.actual) {
                        toolCalls = modelResult.metrics.evaluation.tool_calls.actual;
                    }
                    
                    // 创建一个新对象，包含提取的工具调用
                    this.currentOutput = {
                        ...modelResult,
                        tool_calls: toolCalls
                    };
                    this.showOutputModal = true;
                },
                showEvaluationDetails(modelResult) {
                    this.currentEvaluation = modelResult;
                    // 找到对应的测试用例信息
                    const testCaseResult = this.compareResults.find(r => 
                        r.results.some(res => res.result_id === modelResult.result_id)
                    );
                    this.currentEvaluation.testCaseInfo = testCaseResult || {};
                    this.showEvalModal = true;
                },
                getScoreColor(score) {
                    if (score >= 0.8) return 'text-green-600';
                    if (score >= 0.6) return 'text-yellow-600';
                    if (score >= 0.4) return 'text-orange-600';
                    return 'text-red-600';
                },
                formatScore(value) {
                    // Safely format a score value to 1 decimal place
                    if (value === null || value === undefined) return '0.0';
                    const num = parseFloat(value);
                    return isNaN(num) ? '0.0' : num.toFixed(1);
                },
                calculateToolCallScore(toolCallsEval) {
                    // Calculate total tool call score (sum of 4 dimensions)
                    if (!toolCallsEval) return 0;
                    const nameMatch = parseFloat(this.formatScore(toolCallsEval.name_match)) || 0;
                    const countMatch = parseFloat(this.formatScore(toolCallsEval.count_match)) || 0;
                    const paramsMatch = parseFloat(this.formatScore(toolCallsEval.params_match)) || 0;
                    const valuesMatch = parseFloat(this.formatScore(toolCallsEval.values_match)) || 0;
                    return nameMatch + countMatch + paramsMatch + valuesMatch;
                },
                getProviderClass(provider) {
                    const classes = {
                        openai: 'bg-green-100 text-green-800',
                        anthropic: 'bg-purple-100 text-purple-800',
                        local: 'bg-blue-100 text-blue-800',
                        custom: 'bg-gray-100 text-gray-800'
                    };
                    return classes[provider] || classes.custom;
                },
                getProviderLabel(provider) {
                    const labels = {
                        openai: 'OpenAI',
                        anthropic: 'Claude',
                        local: '本地',
                        custom: '自定义'
                    };
                    return labels[provider] || provider;
                },
                getMetricLabel(metric) {
                    const labels = {
                        response_time: '响应时间',
                        total_tokens: 'Token数量',
                        estimated_cost: '估算成本'
                    };
                    return labels[metric] || metric;
                },
                formatMetricValue(value, metric) {
                    if (!value) return 'N/A';
                    if (metric === 'response_time') return value.toFixed(2) + 's';
                    if (metric === 'estimated_cost') return '$' + value.toFixed(4);
                    return value.toString();
                },
                getBarWidth(value, allResults, metric) {
                    if (!value) return 0;
                    const values = allResults.map(r => r.metrics[metric] || 0).filter(v => v > 0);
                    const max = Math.max(...values);
                    return max > 0 ? (value / max) * 100 : 0;
                },
                getActualWeight(dimension) {
                    // 从评估结果中获取实际使用的权重
                    if (this.currentEvaluation && 
                        this.currentEvaluation.metrics && 
                        this.currentEvaluation.metrics.evaluation && 
                        this.currentEvaluation.metrics.evaluation.weights_used) {
                        const weight = this.currentEvaluation.metrics.evaluation.weights_used[dimension];
                        return weight !== undefined ? weight : 0;
                    }
                    // 如果没有weights_used，返回默认权重
                    const defaultWeights = {
                        'tool_call': 70,
                        'text_similarity': 20,
                        'custom': 10
                    };
                    return defaultWeights[dimension] || 0;
                },
                formatToolCallArguments(call) {
                    // 支持两种格式：OpenAI格式和简化格式
                    try {
                        let args;
                        if (call.function && call.function.arguments) {
                            // OpenAI格式: {function: {name, arguments}}
                            args = call.function.arguments;
                        } else if (call.arguments) {
                            // 简化格式: {name, arguments}
                            args = call.arguments;
                        } else {
                            return '{}';
                        }
                        
                        // 如果是字符串，尝试解析
                        if (typeof args === 'string') {
                            try {
                                args = JSON.parse(args);
                            } catch (e) {
                                return args;
                            }
                        }
                        
                        // 格式化为易读的JSON
                        return JSON.stringify(args, null, 2);
                    } catch (e) {
                        return String(call.arguments || call.function?.arguments || '{}');
                    }
                },
                exportResults() {
                    const data = JSON.stringify(this.compareResults, null, 2);
                    const blob = new Blob([data], { type: 'application/json' });
                    const url = URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = `compare_results_${this.batchId}.json`;
                    a.click();
                    URL.revokeObjectURL(url);
                },
                async loadHistoryList() {
                    this.loadingHistory = true;
                    try {
                        this.batchHistory = await api.get('/api/batch/history');
                    } catch (error) {
                        console.error('加载历史记录失败:', error);
                        alert('加载历史记录失败: ' + error.message);
                    } finally {
                        this.loadingHistory = false;
                    }
                },
                async loadBatchHistory(batch) {
                    try {
                        // 从批次信息中提取模型ID和测试用例ID
                        const modelIds = batch.models.map(m => m.id);
                        const testCaseIds = batch.test_cases.map(tc => tc.id);
                        
                        // 设置选中的模型和测试用例
                        this.selectedModels = modelIds;
                        this.selectedTestCases = testCaseIds;
                        
                        // 加载对比结果
                        await this.loadCompareResults();
                        
                        // 关闭历史弹窗
                        this.showHistoryModal = false;
                        
                        // 滚动到结果区域
                        setTimeout(() => {
                            const resultsSection = document.querySelector('.space-y-6');
                            if (resultsSection) {
                                resultsSection.scrollIntoView({ behavior: 'smooth' });
                            }
                        }, 100);
                    } catch (error) {
                        alert('加载批次结果失败: ' + error.message);
                    }
                },
                async deleteBatch(batchId) {
                    if (!confirm('确定要删除这个批次吗？')) {
                        return;
                    }
                    
                    try {
                        await api.delete(`/api/batch/results/batch/${batchId}`);
                        alert('删除成功！');
                        // 重新加载历史列表
                        await this.loadHistoryList();
                    } catch (error) {
                        alert('删除失败: ' + error.message);
                    }
                },
                formatTimestamp(timestamp) {
                    if (!timestamp) return '未知时间';
                    const date = new Date(timestamp);
                    return date.toLocaleString('zh-CN', {
                        year: 'numeric',
                        month: '2-digit',
                        day: '2-digit',
                        hour: '2-digit',
                        minute: '2-digit',
                        second: '2-digit'
                    });
                }
            }
        }).mount('#app');
    </script>
</body>
</html>

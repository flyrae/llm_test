<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>调试工具 - LLM Test Tool</title>
    <script src="/assets/vendor/vue/vue.global.js"></script>
    <script src="/assets/vendor/tailwind/tailwind.js"></script>
    <link rel="stylesheet" href="/assets/vendor/fontawesome/all.min.css">
    <link rel="stylesheet" href="/assets/css/style.css">
    <style>
        /* 多模态工具箱样式 */
        .mm-tab-btn {
            padding: 8px 16px;
            margin-right: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
            background: white;
            cursor: pointer;
            transition: all 0.3s;
        }
        .mm-tab-btn:hover {
            background: #f0f0f0;
        }
        .mm-tab-btn.active {
            background: #3b82f6;
            color: white;
            border-color: #3b82f6;
        }
        .mm-panel {
            padding: 16px;
            border: 1px solid #e5e7eb;
            border-radius: 8px;
            background: white;
        }
        .mm-result-container {
            margin-top: 16px;
            padding: 16px;
            border: 1px solid #e5e7eb;
            border-radius: 8px;
            background: #f9fafb;
        }
        .mm-image-preview {
            max-width: 100%;
            margin-top: 12px;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        .mm-canvas-container {
            position: relative;
            display: inline-block;
            margin-top: 12px;
        }
        .mm-bbox {
            position: absolute;
            border: 2px solid #ef4444;
            box-sizing: border-box;
            pointer-events: none;
        }
        .mm-bbox-label {
            position: absolute;
            background: #ef4444;
            color: white;
            padding: 2px 6px;
            font-size: 12px;
            border-radius: 2px;
            top: -20px;
            left: 0;
        }
        .mm-text-block {
            padding: 8px;
            margin: 8px 0;
            background: white;
            border-left: 3px solid #3b82f6;
            border-radius: 4px;
        }
        .mm-layout-box {
            border: 2px solid;
            box-sizing: border-box;
            position: absolute;
        }
        .mm-analyze-btn {
            padding: 8px 24px;
            background: #3b82f6;
            color: white;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 500;
            transition: all 0.3s;
        }
        .mm-analyze-btn:hover {
            background: #2563eb;
        }
        .mm-analyze-btn:disabled {
            background: #9ca3af;
            cursor: not-allowed;
        }
    </style>
</head>
<body class="bg-gray-50">
    <div id="app" v-cloak>
        <!-- 导航栏 -->
        <nav class="bg-white shadow-lg">
            <div class="max-w-7xl mx-auto px-4">
                <div class="flex justify-between items-center h-16">
                    <div class="flex items-center space-x-2">
                        <i class="fas fa-robot text-2xl text-blue-600"></i>
                        <span class="text-xl font-bold text-gray-800">LLM Test Tool</span>
                    </div>
                    <div class="flex space-x-4">
                        <a href="/" class="px-4 py-2 rounded-md text-gray-600 hover:bg-gray-100">
                            <i class="fas fa-home mr-2"></i>首页
                        </a>
                        <a href="/pages/models.html" class="px-4 py-2 rounded-md text-gray-600 hover:bg-gray-100">
                            <i class="fas fa-cog mr-2"></i>模型配置
                        </a>
                        <a href="/pages/testcases.html" class="px-4 py-2 rounded-md text-gray-600 hover:bg-gray-100">
                            <i class="fas fa-tasks mr-2"></i>测试用例
                        </a>
                        <a href="/pages/tools.html" class="px-4 py-2 rounded-md text-gray-600 hover:bg-gray-100">
                            <i class="fas fa-wrench mr-2"></i>工具管理
                        </a>
                        <a href="/pages/system_prompts.html" class="px-4 py-2 rounded-md text-gray-600 hover:bg-gray-100">
                            <i class="fas fa-comment-dots mr-2"></i>系统提示词
                        </a>
                        <a href="/pages/debug.html" class="px-4 py-2 rounded-md bg-blue-100 text-blue-700">
                            <i class="fas fa-bug mr-2"></i>调试
                        </a>
                        <a href="/pages/compare.html" class="px-4 py-2 rounded-md text-gray-600 hover:bg-gray-100">
                            <i class="fas fa-code-compare mr-2"></i>对比测试
                        </a>
                    </div>
                </div>
            </div>
        </nav>

        <main class="max-w-7xl mx-auto px-4 py-8">
            <h1 class="text-3xl font-bold text-gray-800 mb-6">
                <i class="fas fa-bug mr-2 text-purple-600"></i>调试工具
            </h1>

            <!-- 多模态工具箱 -->
            <div id="multimodal-toolbox" class="bg-white rounded-lg shadow-md p-6 mb-6">
                <h3 class="text-xl font-bold text-gray-800 mb-4">
                    <i class="fas fa-images text-purple-600 mr-2"></i>多模态工具箱
                    <span class="text-sm font-normal text-gray-500 ml-2">（可选，建议在对话结果中使用快捷操作）</span>
                </h3>
                <div class="mb-4 p-3 bg-blue-50 border border-blue-200 rounded-lg">
                    <p class="text-sm text-blue-700">
                        <i class="fas fa-lightbulb mr-1"></i>
                        <strong>提示：</strong>推荐在主对话流中上传图片提问，模型回复后点击"快捷操作"按钮（OCR/2D Grounding/版面分析）即可直接可视化，无需重复调用模型。
                    </p>
                </div>
                <div class="mb-4">
                    <button id="tab-grounding" class="mm-tab-btn" onclick="switchMMTab('grounding')">
                        <i class="fas fa-crosshairs mr-1"></i>2D Grounding
                    </button>
                    <button id="tab-ocr" class="mm-tab-btn" onclick="switchMMTab('ocr')">
                        <i class="fas fa-text mr-1"></i>OCR
                    </button>
                    <button id="tab-layout" class="mm-tab-btn" onclick="switchMMTab('layout')">
                        <i class="fas fa-th-large mr-1"></i>版面分析
                    </button>
                </div>
                
                <!-- 2D Grounding 面板 -->
                <div id="mm-panel-grounding" class="mm-panel">
                    <div class="mb-4">
                        <label class="block text-sm font-medium text-gray-700 mb-2">上传图片</label>
                        <input type="file" accept="image/*" id="grounding-image" class="block w-full text-sm" onchange="previewImage('grounding')" />
                    </div>
                    <div class="mb-4">
                        <label class="block text-sm font-medium text-gray-700 mb-2">检测目标（支持多个，用逗号分隔）</label>
                        <input type="text" id="grounding-targets" placeholder="例如: 人, 汽车, 建筑物" 
                               class="w-full px-4 py-2 border rounded-lg" />
                    </div>
                    <button onclick="runGrounding()" class="mm-analyze-btn">
                        <i class="fas fa-play mr-2"></i>开始分析
                    </button>
                    <div id="grounding-result"></div>
                </div>
                
                <!-- OCR 面板 -->
                <div id="mm-panel-ocr" class="mm-panel" style="display:none;">
                    <div class="mb-4">
                        <label class="block text-sm font-medium text-gray-700 mb-2">上传图片</label>
                        <input type="file" accept="image/*" id="ocr-image" class="block w-full text-sm" onchange="previewImage('ocr')" />
                    </div>
                    <div class="mb-4">
                        <label class="flex items-center">
                            <input type="checkbox" id="ocr-structured" class="mr-2" />
                            <span class="text-sm">结构化输出（保留位置信息）</span>
                        </label>
                    </div>
                    <button onclick="runOCR()" class="mm-analyze-btn">
                        <i class="fas fa-play mr-2"></i>开始分析
                    </button>
                    <div id="ocr-result"></div>
                </div>
                
                <!-- 版面分析面板 -->
                <div id="mm-panel-layout" class="mm-panel" style="display:none;">
                    <div class="mb-4">
                        <label class="block text-sm font-medium text-gray-700 mb-2">上传图片</label>
                        <input type="file" accept="image/*" id="layout-image" class="block w-full text-sm" onchange="previewImage('layout')" />
                    </div>
                    <div class="mb-4">
                        <p class="text-sm text-gray-600">
                            <i class="fas fa-info-circle mr-1"></i>
                            自动识别文档版面结构，包括标题、段落、图片、表格等区域
                        </p>
                    </div>
                    <button onclick="runLayout()" class="mm-analyze-btn">
                        <i class="fas fa-play mr-2"></i>开始分析
                    </button>
                    <div id="layout-result"></div>
                </div>
            </div>
            <script>
            // 多模态Tab切换
            function switchMMTab(tab) {
              ["grounding","ocr","layout"].forEach(t => {
                const panel = document.getElementById('mm-panel-'+t);
                const btn = document.getElementById('tab-'+t);
                if (panel) panel.style.display = (t===tab)?'block':'none';
                if (btn) btn.classList.toggle('active', t===tab);
              });
            }
            
            // 图片预览
            function previewImage(type) {
                const fileInput = document.getElementById(`${type}-image`);
                const resultDiv = document.getElementById(`${type}-result`);
                
                if (fileInput.files && fileInput.files[0]) {
                    const reader = new FileReader();
                    reader.onload = function(e) {
                        resultDiv.innerHTML = `
                            <div class="mm-result-container">
                                <p class="text-sm text-gray-600 mb-2"><i class="fas fa-check-circle text-green-600 mr-1"></i>图片已加载</p>
                                <img src="${e.target.result}" class="mm-image-preview" alt="预览图" />
                            </div>
                        `;
                    };
                    reader.readAsDataURL(fileInput.files[0]);
                }
            }
            
            // 2D Grounding 分析
            async function runGrounding() {
                const fileInput = document.getElementById('grounding-image');
                const targetsInput = document.getElementById('grounding-targets');
                const resultDiv = document.getElementById('grounding-result');
                
                if (!fileInput.files || !fileInput.files[0]) {
                    alert('请先上传图片');
                    return;
                }
                
                const targets = targetsInput.value.trim();
                if (!targets) {
                    alert('请输入检测目标');
                    return;
                }
                
                resultDiv.innerHTML = '<div class="mm-result-container"><i class="fas fa-spinner fa-spin mr-2"></i>分析中...</div>';
                
                try {
                    const base64 = await fileToBase64(fileInput.files[0]);
                    const prompt = `请检测图片中的以下目标：${targets}。
要求：
1. 返回每个目标的边界框坐标
2. 格式：[[x1, y1, x2, y2, "标签"], ...]
3. 坐标为像素值，x1,y1是左上角，x2,y2是右下角
4. 只返回JSON数组，不要其他说明文字

示例：[[100, 50, 300, 200, "人"], [400, 100, 600, 300, "汽车"]]`;
                    
                    // 调用后端 API（需要获取选中的VL模型）
                    const response = await callVLModel(base64, prompt);
                    
                    // 渲染结果（在图片上绘制检测框）
                    renderGroundingResult(base64, response, resultDiv);
                } catch (error) {
                    resultDiv.innerHTML = `<div class="mm-result-container text-red-600"><i class="fas fa-exclamation-circle mr-1"></i>错误: ${error.message}</div>`;
                }
            }
            
            // OCR 分析
            async function runOCR() {
                const fileInput = document.getElementById('ocr-image');
                const structuredCheckbox = document.getElementById('ocr-structured');
                const resultDiv = document.getElementById('ocr-result');
                
                if (!fileInput.files || !fileInput.files[0]) {
                    alert('请先上传图片');
                    return;
                }
                
                resultDiv.innerHTML = '<div class="mm-result-container"><i class="fas fa-spinner fa-spin mr-2"></i>分析中...</div>';
                
                try {
                    const base64 = await fileToBase64(fileInput.files[0]);
                    const structured = structuredCheckbox.checked;
                    const prompt = structured ? 
                        `请识别图片中的所有文字，要求：
1. 保留每个文字块的位置信息
2. 返回JSON数组格式：[{"bbox_2d": [x1, y1, x2, y2], "text_content": "文字内容"}, ...]
3. bbox_2d为文字块的边界框坐标（像素值）
4. 按从上到下、从左到右的阅读顺序排列
5. 只返回JSON，不要其他说明

示例：[{"bbox_2d": [34, 14, 181, 29], "text_content": "标题文字"}, {"bbox_2d": [34, 50, 400, 70], "text_content": "正文内容"}]` : 
                        '请识别图片中的所有文字内容，按阅读顺序输出纯文本即可';
                    
                    const response = await callVLModel(base64, prompt);
                    
                    renderOCRResult(response, resultDiv, structured);
                } catch (error) {
                    resultDiv.innerHTML = `<div class="mm-result-container text-red-600"><i class="fas fa-exclamation-circle mr-1"></i>错误: ${error.message}</div>`;
                }
            }
            
            // 版面分析
            async function runLayout() {
                const fileInput = document.getElementById('layout-image');
                const resultDiv = document.getElementById('layout-result');
                
                if (!fileInput.files || !fileInput.files[0]) {
                    alert('请先上传图片');
                    return;
                }
                
                resultDiv.innerHTML = '<div class="mm-result-container"><i class="fas fa-spinner fa-spin mr-2"></i>分析中...</div>';
                
                try {
                    const base64 = await fileToBase64(fileInput.files[0]);
                    const prompt = `请分析图片的版面结构，要求：
1. 识别所有版面元素：标题、段落、图片、表格、列表等
2. 返回JSON格式的结构化数据
3. 包含每个元素的类型、位置（bbox）、层级关系
4. 格式：[{"type": "元素类型", "bbox": [x1, y1, x2, y2], "content": "内容描述", "level": 1}, ...]
5. 只返回JSON，不要其他说明

元素类型包括：title（标题）、paragraph（段落）、image（图片）、table（表格）、list（列表）等`;
                    
                    const response = await callVLModel(base64, prompt);
                    
                    renderLayoutResult(base64, response, resultDiv);
                } catch (error) {
                    resultDiv.innerHTML = `<div class="mm-result-container text-red-600"><i class="fas fa-exclamation-circle mr-1"></i>错误: ${error.message}</div>`;
                }
            }
            
            // 文件转Base64
            function fileToBase64(file) {
                return new Promise((resolve, reject) => {
                    const reader = new FileReader();
                    reader.onload = () => resolve(reader.result);
                    reader.onerror = reject;
                    reader.readAsDataURL(file);
                });
            }
            
            // 调用VL模型（使用当前选中的模型）
            async function callVLModel(imageBase64, prompt) {
                const app = document.querySelector('#app').__vue_app__;
                const vm = app._instance.proxy;
                
                if (!vm.selectedModelId) {
                    throw new Error('请先选择一个VL模型');
                }
                
                const content = [
                    { type: 'text', text: prompt },
                    { type: 'image_url', image_url: { url: imageBase64 } }
                ];
                
                const response = await fetch('/api/debug/chat', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        model_id: vm.selectedModelId,
                        content: content,
                        system_prompt: vm.systemPrompt || '',
                        params: vm.params,
                        stream: false
                    })
                });
                
                if (!response.ok) {
                    const error = await response.json();
                    throw new Error(error.detail || '请求失败');
                }
                
                const result = await response.json();
                return result.output;
            }
            
            // 渲染 Grounding 结果
            function renderGroundingResult(imageBase64, response, container) {
                // 尝试解析模型返回的坐标数据
                let bboxes = [];
                try {
                    // 尝试从响应中提取JSON数组
                    const jsonMatch = response.match(/\[\s*\[[\d,\s\[\]"'a-zA-Z\u4e00-\u9fa5]+\]\s*\]/);
                    if (jsonMatch) {
                        bboxes = JSON.parse(jsonMatch[0]);
                    }
                } catch (e) {
                    console.log('无法解析坐标数据:', e);
                }
                
                const hasValidBboxes = bboxes.length > 0 && Array.isArray(bboxes[0]);
                const canvasId = 'grounding-canvas-' + Date.now();
                
                container.innerHTML = `
                    <div class="mm-result-container">
                        <h4 class="font-bold mb-2"><i class="fas fa-check-circle text-green-600 mr-1"></i>检测完成</h4>
                        ${hasValidBboxes ? `
                            <div class="mb-2 text-sm text-green-600">
                                <i class="fas fa-info-circle mr-1"></i>检测到 ${bboxes.length} 个目标
                            </div>
                            <div style="position:relative; display:inline-block;">
                                <canvas id="${canvasId}" style="border:1px solid #ddd; border-radius:8px; box-shadow: 0 2px 8px rgba(0,0,0,0.1);"></canvas>
                            </div>
                            <div class="mt-4 p-4 bg-white rounded border">
                                <h5 class="font-semibold mb-2">检测结果列表：</h5>
                                <ul class="space-y-1">
                                    ${bboxes.map((bbox, i) => {
                                        const label = bbox.length > 4 ? bbox[4] : '目标' + (i+1);
                                        return `<li class="text-sm"><span class="inline-block w-4 h-4 mr-2" style="background:${getColorForIndex(i)};"></span>${label}: [${bbox.slice(0,4).join(', ')}]</li>`;
                                    }).join('')}
                                </ul>
                            </div>
                        ` : `
                            <div class="mm-canvas-container">
                                <img src="${imageBase64}" class="mm-image-preview" alt="检测结果" />
                            </div>
                        `}
                        <div class="mt-4 p-4 bg-gray-50 rounded border">
                            <details>
                                <summary class="font-semibold cursor-pointer">原始模型响应</summary>
                                <pre class="text-sm text-gray-700 whitespace-pre-wrap mt-2">${escapeHtml(response)}</pre>
                            </details>
                        </div>
                        <button onclick="copyToClipboard(\`${response.replace(/`/g, '\\`').replace(/\$/g, '\\$')}\`);" 
                                class="mt-2 px-4 py-2 bg-blue-500 text-white rounded hover:bg-blue-600">
                            <i class="fas fa-copy mr-1"></i>复制结果
                        </button>
                    </div>
                `;
                
                // 如果有有效的bbox数据，绘制到canvas上
                if (hasValidBboxes) {
                    setTimeout(() => drawBboxesOnCanvas(canvasId, imageBase64, bboxes), 100);
                }
            }
            
            // 在Canvas上绘制检测框
            function drawBboxesOnCanvas(canvasId, imageBase64, bboxes) {
                const canvas = document.getElementById(canvasId);
                if (!canvas) return;
                
                const ctx = canvas.getContext('2d');
                const img = new Image();
                
                img.onload = function() {
                    // 获取原始图片尺寸
                    const imgWidth = img.width;
                    const imgHeight = img.height;
                    
                    // 设置canvas尺寸
                    const maxWidth = 800;
                    let scale = 1;
                    if (imgWidth > maxWidth) {
                        scale = maxWidth / imgWidth;
                    }
                    
                    canvas.width = imgWidth * scale;
                    canvas.height = imgHeight * scale;
                    
                    console.log('Grounding Canvas Info:', {
                        originalSize: [imgWidth, imgHeight],
                        canvasSize: [canvas.width, canvas.height],
                        scale: scale,
                        bboxCount: bboxes.length
                    });
                    
                    // 绘制图片
                    ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
                    
                    // 绘制检测框
                    bboxes.forEach((bbox, i) => {
                        if (bbox.length >= 4) {
                            let [x1, y1, x2, y2] = bbox.slice(0, 4);
                            const label = bbox.length > 4 ? bbox[4] : '目标' + (i+1);
                            const color = getColorForIndex(i);
                            
                            // 应用缩放
                            x1 *= scale;
                            y1 *= scale;
                            x2 *= scale;
                            y2 *= scale;
                            
                            const width = x2 - x1;
                            const height = y2 - y1;
                            
                            console.log(`Grounding Box ${i+1}:`, {
                                original: bbox.slice(0, 4),
                                scaled: [x1, y1, x2, y2],
                                size: [width, height],
                                label: label
                            });
                            
                            // 绘制矩形框
                            ctx.strokeStyle = color;
                            ctx.lineWidth = 3;
                            ctx.strokeRect(x1, y1, width, height);
                            
                            // 绘制标签背景
                            ctx.fillStyle = color;
                            ctx.font = 'bold 14px Arial';
                            const labelText = label;
                            const textWidth = ctx.measureText(labelText).width;
                            ctx.fillRect(x1, y1 - 25, textWidth + 10, 25);
                            
                            // 绘制标签文字
                            ctx.fillStyle = 'white';
                            ctx.fillText(labelText, x1 + 5, y1 - 7);
                        }
                    });
                };
                
                img.src = imageBase64;
            }
            
            // 获取颜色（用于区分不同的检测框）
            function getColorForIndex(index) {
                const colors = ['#ef4444', '#3b82f6', '#10b981', '#f59e0b', '#8b5cf6', '#ec4899', '#14b8a6', '#f97316'];
                return colors[index % colors.length];
            }
            
            // HTML转义
            function escapeHtml(text) {
                const div = document.createElement('div');
                div.textContent = text;
                return div.innerHTML;
            }
            
            // 渲染 OCR 结果
            function renderOCRResult(response, container, structured) {
                // 尝试解析OCR结果中的bbox和文本
                let ocrData = [];
                let hasStructuredData = false;
                let formattedResponse = response;
                
                try {
                    const jsonMatch = response.match(/\{[\s\S]*\}|\[[\s\S]*\]/);
                    if (jsonMatch) {
                        const jsonObj = JSON.parse(jsonMatch[0]);
                        formattedResponse = JSON.stringify(jsonObj, null, 2);
                        
                        // 检查是否是结构化OCR数据（包含bbox_2d和text_content）
                        if (Array.isArray(jsonObj)) {
                            hasStructuredData = jsonObj.some(item => item.bbox_2d && item.text_content);
                            if (hasStructuredData) {
                                ocrData = jsonObj;
                            }
                        }
                    }
                } catch (e) {
                    console.log('无法解析OCR数据:', e);
                }
                
                // 获取原始图片（从OCR输入框）
                const fileInput = document.getElementById('ocr-image');
                const canvasId = 'ocr-canvas-' + Date.now();
                let imageBase64 = '';
                
                if (fileInput.files && fileInput.files[0]) {
                    const reader = new FileReader();
                    reader.onload = function(e) {
                        imageBase64 = e.target.result;
                        
                        if (hasStructuredData && ocrData.length > 0) {
                            // 渲染可视化版本
                            container.innerHTML = `
                                <div class="mm-result-container">
                                    <h4 class="font-bold mb-2"><i class="fas fa-check-circle text-green-600 mr-1"></i>识别完成</h4>
                                    <div class="mb-2 text-sm text-green-600">
                                        <i class="fas fa-info-circle mr-1"></i>识别到 ${ocrData.length} 个文本块
                                    </div>
                                    <div class="grid grid-cols-1 lg:grid-cols-2 gap-4">
                                        <div>
                                            <h5 class="font-semibold mb-2">可视化结果：</h5>
                                            <canvas id="${canvasId}" style="border:1px solid #ddd; border-radius:8px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); max-width:100%;"></canvas>
                                        </div>
                                        <div>
                                            <h5 class="font-semibold mb-2">识别文本列表：</h5>
                                            <div class="p-4 bg-white rounded border max-h-96 overflow-y-auto">
                                                ${ocrData.map((item, i) => `
                                                    <div class="mm-text-block" style="border-left-color:${getColorForIndex(i)};">
                                                        <div class="text-xs text-gray-500 mb-1">区域 ${i+1} [${item.bbox_2d.join(', ')}]</div>
                                                        <div class="text-sm">${escapeHtml(item.text_content)}</div>
                                                    </div>
                                                `).join('')}
                                            </div>
                                        </div>
                                    </div>
                                    <div class="mt-4 p-4 bg-gray-50 rounded border">
                                        <details>
                                            <summary class="font-semibold cursor-pointer">原始JSON数据</summary>
                                            <pre class="text-sm text-gray-700 whitespace-pre-wrap mt-2">${escapeHtml(formattedResponse)}</pre>
                                        </details>
                                    </div>
                                    <div class="mt-2 space-x-2">
                                        <button onclick="copyOCRText();" 
                                                class="px-4 py-2 bg-blue-500 text-white rounded hover:bg-blue-600">
                                            <i class="fas fa-copy mr-1"></i>复制纯文本
                                        </button>
                                        <button onclick="copyToClipboard(\`${formattedResponse.replace(/`/g, '\\`').replace(/\$/g, '\\$')}\`);" 
                                                class="px-4 py-2 bg-gray-500 text-white rounded hover:bg-gray-600">
                                            <i class="fas fa-code mr-1"></i>复制JSON
                                        </button>
                                    </div>
                                </div>
                            `;
                            
                            // 绘制OCR可视化
                            setTimeout(() => drawOCROnCanvas(canvasId, imageBase64, ocrData), 100);
                            
                            // 存储OCR数据供复制使用
                            window.currentOCRData = ocrData;
                        } else {
                            // 渲染普通文本版本
                            renderSimpleOCRResult(formattedResponse, response, container);
                        }
                    };
                    reader.readAsDataURL(fileInput.files[0]);
                } else {
                    // 没有图片，只显示文本
                    renderSimpleOCRResult(formattedResponse, response, container);
                }
            }
            
            // 渲染简单OCR结果（无可视化）
            function renderSimpleOCRResult(formattedResponse, originalResponse, container) {
                container.innerHTML = `
                    <div class="mm-result-container">
                        <h4 class="font-bold mb-2"><i class="fas fa-check-circle text-green-600 mr-1"></i>识别完成</h4>
                        <div class="p-4 bg-white rounded border max-h-96 overflow-y-auto">
                            <pre class="text-sm text-gray-700 whitespace-pre-wrap">${escapeHtml(formattedResponse)}</pre>
                        </div>
                        <button onclick="copyToClipboard(\`${originalResponse.replace(/`/g, '\\`').replace(/\$/g, '\\$')}\`);" 
                                class="mt-2 px-4 py-2 bg-blue-500 text-white rounded hover:bg-blue-600">
                            <i class="fas fa-copy mr-1"></i>复制文本
                        </button>
                    </div>
                `;
            }
            
            // 在Canvas上绘制OCR结果
            function drawOCROnCanvas(canvasId, imageBase64, ocrData) {
                const canvas = document.getElementById(canvasId);
                if (!canvas) return;
                
                const ctx = canvas.getContext('2d');
                const img = new Image();
                
                img.onload = function() {
                    // 获取原始图片尺寸
                    const imgWidth = img.width;
                    const imgHeight = img.height;
                    
                    // 设置canvas尺寸（限制最大宽度）
                    const maxWidth = 600;
                    let scale = 1;
                    if (imgWidth > maxWidth) {
                        scale = maxWidth / imgWidth;
                    }
                    
                    canvas.width = imgWidth * scale;
                    canvas.height = imgHeight * scale;
                    
                    console.log('OCR Canvas Info:', {
                        originalSize: [imgWidth, imgHeight],
                        canvasSize: [canvas.width, canvas.height],
                        scale: scale,
                        dataCount: ocrData.length
                    });
                    
                    // 绘制图片
                    ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
                    
                    // 绘制文本框
                    ocrData.forEach((item, i) => {
                        if (item.bbox_2d && item.bbox_2d.length >= 4) {
                            // 坐标已经是像素坐标，直接缩放
                            let [x1, y1, x2, y2] = item.bbox_2d;
                            
                            // 应用缩放
                            x1 *= scale;
                            y1 *= scale;
                            x2 *= scale;
                            y2 *= scale;
                            
                            const width = x2 - x1;
                            const height = y2 - y1;
                            const color = getColorForIndex(i);
                            
                            console.log(`OCR Box ${i+1}:`, {
                                original: item.bbox_2d,
                                scaled: [x1, y1, x2, y2],
                                size: [width, height],
                                text: item.text_content
                            });
                            
                            // 绘制半透明背景
                            ctx.fillStyle = color + '30'; // 增加透明度
                            ctx.fillRect(x1, y1, width, height);
                            
                            // 绘制边框
                            ctx.strokeStyle = color;
                            ctx.lineWidth = 2;
                            ctx.strokeRect(x1, y1, width, height);
                            
                            // 绘制序号标签（左上角）
                            const labelSize = 16;
                            const labelX = x1 + 5;
                            const labelY = y1 + 5;
                            
                            // 绘制圆形背景
                            ctx.fillStyle = color;
                            ctx.beginPath();
                            ctx.arc(labelX + labelSize/2, labelY + labelSize/2, labelSize/2, 0, 2 * Math.PI);
                            ctx.fill();
                            
                            // 绘制序号文字
                            ctx.fillStyle = 'white';
                            ctx.font = 'bold 11px Arial';
                            ctx.textAlign = 'center';
                            ctx.textBaseline = 'middle';
                            ctx.fillText((i + 1).toString(), labelX + labelSize/2, labelY + labelSize/2);
                        }
                    });
                };
                
                img.src = imageBase64;
            }
            
            // 复制OCR纯文本
            function copyOCRText() {
                if (window.currentOCRData && window.currentOCRData.length > 0) {
                    const text = window.currentOCRData.map(item => item.text_content).join('\n');
                    copyToClipboard(text);
                } else {
                    alert('没有可复制的文本');
                }
            }
            
            // 渲染版面分析结果
            function renderLayoutResult(imageBase64, response, container) {
                // 尝试美化JSON输出
                let formattedResponse = response;
                try {
                    const jsonMatch = response.match(/\{[\s\S]*\}|\[[\s\S]*\]/);
                    if (jsonMatch) {
                        const jsonObj = JSON.parse(jsonMatch[0]);
                        formattedResponse = JSON.stringify(jsonObj, null, 2);
                    }
                } catch (e) {
                    // 保持原样
                }
                
                container.innerHTML = `
                    <div class="mm-result-container">
                        <h4 class="font-bold mb-2"><i class="fas fa-check-circle text-green-600 mr-1"></i>分析完成</h4>
                        <div class="grid grid-cols-1 lg:grid-cols-2 gap-4">
                            <div>
                                <h5 class="font-semibold mb-2">原图：</h5>
                                <img src="${imageBase64}" class="mm-image-preview" alt="原图" />
                            </div>
                            <div>
                                <h5 class="font-semibold mb-2">结构分析：</h5>
                                <div class="p-4 bg-white rounded border max-h-96 overflow-y-auto">
                                    <pre class="text-sm text-gray-700 whitespace-pre-wrap">${escapeHtml(formattedResponse)}</pre>
                                </div>
                            </div>
                        </div>
                        <button onclick="copyToClipboard(\`${response.replace(/`/g, '\\`').replace(/\$/g, '\\$')}\`);" 
                                class="mt-2 px-4 py-2 bg-blue-500 text-white rounded hover:bg-blue-600">
                            <i class="fas fa-download mr-1"></i>导出结果
                        </button>
                    </div>
                `;
            }
            
            // 复制到剪贴板
            function copyToClipboard(text) {
                navigator.clipboard.writeText(text).then(() => {
                    alert('已复制到剪贴板');
                }).catch(err => {
                    console.error('复制失败:', err);
                    alert('复制失败，请手动复制');
                });
            }
            
            // 默认显示grounding
            switchMMTab('grounding');
            </script>

            <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                <!-- 左侧配置面板 -->
                <div class="lg:col-span-1 space-y-6">
                    <!-- 模型选择 -->
                    <div class="bg-white rounded-lg shadow-md p-6">
                        <h3 class="text-lg font-bold text-gray-800 mb-4">模型选择</h3>
                        <select v-model="selectedModelId" 
                                class="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500">
                            <option value="">选择模型...</option>
                            <option v-for="model in models" :key="model.id" :value="model.id">
                                {{ model.name }} ({{ model.model_name }})
                            </option>
                        </select>
                    </div>

                    <!-- 参数调整 -->
                    <div class="bg-white rounded-lg shadow-md p-6">
                        <h3 class="text-lg font-bold text-gray-800 mb-4">参数调整</h3>
                        <div class="space-y-4">
                            <!-- 流式输出开关 -->
                            <div class="flex items-center justify-between p-3 bg-blue-50 rounded-lg">
                                <div class="flex items-center">
                                    <i class="fas fa-stream text-blue-600 mr-2"></i>
                                    <span class="text-sm font-medium text-gray-700">流式输出</span>
                                </div>
                                <label class="relative inline-flex items-center cursor-pointer">
                                    <input type="checkbox" v-model="streamMode" class="sr-only peer">
                                    <div class="w-11 h-6 bg-gray-200 peer-focus:outline-none peer-focus:ring-4 peer-focus:ring-blue-300 rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-blue-600"></div>
                                </label>
                            </div>
                            
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">
                                    Temperature: {{ params.temperature }}
                                </label>
                                <input v-model.number="params.temperature" 
                                       type="range" min="0" max="2" step="0.1"
                                       class="w-full">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">
                                    Max Tokens
                                </label>
                                <input v-model.number="params.max_tokens" 
                                       type="number" min="1" max="4000"
                                       class="w-full px-4 py-2 border rounded-lg">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">
                                    Top P: {{ params.top_p }}
                                </label>
                                <input v-model.number="params.top_p" 
                                       type="range" min="0" max="1" step="0.05"
                                       class="w-full">
                            </div>
                        </div>
                    </div>

                    <!-- 历史记录 -->
                    <div class="bg-white rounded-lg shadow-md p-6">
                        <h3 class="text-lg font-bold text-gray-800 mb-4">历史记录</h3>
                        <div v-if="history.length === 0" class="text-gray-500 text-center py-4">
                            暂无历史记录
                        </div>
                        <div v-else>
                            <div class="text-xs text-gray-500 mb-2 px-2">
                                <i class="fas fa-info-circle mr-1"></i>点击加载提示词（最多保存10条）
                            </div>
                            <div class="space-y-2 max-h-64 overflow-y-auto">
                                <div v-for="(item, index) in history" :key="index"
                                     @click="loadHistory(item)"
                                     class="p-3 bg-gray-50 rounded cursor-pointer hover:bg-gray-100">
                                    <p class="text-sm text-gray-600 truncate">{{ item.prompt.substring(0, 50) }}...</p>
                                    <p class="text-xs text-gray-400 mt-1">{{ formatTime(item.timestamp) }}</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- 右侧对话面板 -->
                <div class="lg:col-span-2 space-y-6">
                    <!-- 系统提示词 -->
                    <div class="bg-white rounded-lg shadow-md p-6">
                        <div class="flex items-center justify-between mb-2">
                            <label class="block text-sm font-medium text-gray-700">
                                <i class="fas fa-comment-dots mr-1"></i>系统提示词
                            </label>
                            <a href="/pages/system_prompts.html" 
                               class="text-xs text-blue-600 hover:text-blue-800"
                               target="_blank">
                                <i class="fas fa-cog mr-1"></i>管理模板
                            </a>
                        </div>
                        
                        <!-- 快速选择 -->
                        <div class="mb-3">
                            <select v-model="selectedPromptId" 
                                    @change="loadSelectedPrompt"
                                    class="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500 text-sm">
                                <option value="">选择预设模板...</option>
                                <optgroup v-for="(prompts, category) in groupedPrompts" 
                                          :key="category" 
                                          :label="category || '未分类'">
                                    <option v-for="prompt in prompts" 
                                            :key="prompt.id" 
                                            :value="prompt.id">
                                        {{ prompt.name }}
                                    </option>
                                </optgroup>
                            </select>
                        </div>
                        
                        <!-- 提示词内容 -->
                        <textarea v-model="systemPrompt" 
                                  rows="3" 
                                  placeholder="设置系统角色和行为，或从上方选择预设模板..."
                                  class="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500"></textarea>
                        
                        <!-- 清空按钮 -->
                        <div class="mt-2 flex justify-end">
                            <button v-if="systemPrompt" 
                                    @click="systemPrompt = ''; selectedPromptId = ''" 
                                    class="text-xs text-gray-600 hover:text-gray-800">
                                <i class="fas fa-times mr-1"></i>清空
                            </button>
                        </div>
                    </div>

                    <!-- 工具选择 -->
                    <div class="bg-white rounded-lg shadow-md p-6">
                        <label class="block text-sm font-medium text-gray-700 mb-2">
                            <i class="fas fa-wrench mr-1"></i>选择工具（测试Function Calling）
                        </label>
                        <div class="border rounded-lg p-4 max-h-48 overflow-y-auto">
                            <div v-if="availableTools.length === 0" class="text-gray-500 text-sm text-center py-2">
                                暂无可用工具，<a href="/pages/tools.html" class="text-blue-600 hover:underline">前往创建</a>
                            </div>
                            <label v-for="tool in availableTools" :key="tool.id"
                                   class="flex items-start p-2 hover:bg-gray-50 rounded cursor-pointer">
                                <input type="checkbox" :value="tool.id" v-model="selectedTools" class="mt-1 mr-3">
                                <div class="flex-1">
                                    <div class="font-semibold text-sm">{{ tool.name }}</div>
                                    <div class="text-xs text-gray-500">{{ tool.description }}</div>
                                </div>
                            </label>
                        </div>
                        
                        <!-- 模拟工具执行开关 -->
                        <div v-if="selectedTools.length > 0" class="mt-4 pt-4 border-t">
                            <label class="flex items-center cursor-pointer">
                                <input type="checkbox" v-model="useMock" 
                                       class="w-4 h-4 text-purple-600 border-gray-300 rounded focus:ring-purple-500">
                                <span class="ml-2 text-sm text-gray-700">
                                    <i class="fas fa-mask mr-1 text-purple-600"></i>
                                    使用模拟工具执行 (Agent训练模式)
                                </span>
                            </label>
                            <p class="mt-2 text-xs text-gray-500 ml-6">
                                启用后将使用配置的模拟响应而不调用真实API，适合训练场景
                            </p>
                        </div>
                    </div>

                    <!-- 对话历史 -->
                    <div v-if="conversationHistory.length > 0" class="bg-white rounded-lg shadow-md p-6">
                        <div class="flex items-center justify-between mb-4">
                            <h3 class="text-lg font-bold text-gray-800">
                                <i class="fas fa-comments text-blue-600 mr-2"></i>对话历史 ({{ conversationHistory.length }} 轮)
                            </h3>
                            <button @click="clearConversation" 
                                    class="text-sm text-red-600 hover:text-red-800">
                                <i class="fas fa-trash mr-1"></i>清空对话
                            </button>
                        </div>
                        <div class="space-y-2 max-h-96 overflow-y-auto">
                            <div v-for="(message, index) in conversationHistory" :key="index"
                                 class="p-3 rounded-lg text-sm"
                                 :class="message.role === 'user' ? 'bg-blue-50 border border-blue-200' : 'bg-green-50 border border-green-200'">
                                <div class="font-semibold mb-1" 
                                     :class="message.role === 'user' ? 'text-blue-700' : 'text-green-700'">
                                    {{ message.role === 'user' ? '👤 用户' : '🤖 助手' }}:
                                </div>
                                <div v-if="message.content" class="text-gray-700 whitespace-pre-wrap">{{ message.content }}</div>
                                <div v-if="message.tool_calls && message.tool_calls.length > 0" class="mt-2">
                                    <div class="text-xs font-semibold text-yellow-700 mb-1">
                                        <i class="fas fa-wrench mr-1"></i>工具调用:
                                    </div>
                                    <div v-for="(call, idx) in message.tool_calls" :key="idx" 
                                         class="bg-yellow-50 border border-yellow-300 rounded p-2 text-xs mb-1 last:mb-0">
                                        <div class="flex items-center justify-between cursor-pointer hover:bg-yellow-100 -m-2 p-2 rounded"
                                             @click="toggleToolCallDetails(index, idx)">
                                            <div class="font-medium flex items-center">
                                                <i class="fas mr-2 transition-transform"
                                                   :class="isToolCallExpanded(index, idx) ? 'fa-chevron-down' : 'fa-chevron-right'"></i>
                                                {{ call.function.name }}
                                            </div>
                                            <span class="text-gray-500 text-xs">
                                                <i class="fas fa-eye mr-1"></i>{{ isToolCallExpanded(index, idx) ? '收起' : '展开' }}
                                            </span>
                                        </div>
                                        <div v-show="isToolCallExpanded(index, idx)" class="mt-2 pt-2 border-t border-yellow-200">
                                            <div class="text-gray-600 mb-1 font-medium">参数:</div>
                                            <pre class="text-gray-600 font-mono bg-white p-2 rounded border border-yellow-200 overflow-x-auto max-h-64 overflow-y-auto">{{ formatJson(call.function.arguments) }}</pre>
                                        </div>
                                    </div>
                                </div>
                                
                                <!-- 快捷操作按钮（仅显示在助手回复中且包含图片的对话） -->
                                <div v-if="message.role === 'assistant' && hasImageInConversation(index)" class="mt-3 pt-3 border-t border-gray-200">
                                    <div class="text-xs text-gray-500 mb-2">
                                        <i class="fas fa-magic mr-1"></i>快捷操作：
                                    </div>
                                    <div class="flex flex-wrap gap-2">
                                        <button @click="renderVisualization(index, 'ocr')" 
                                                class="px-3 py-1 text-xs bg-blue-500 text-white rounded hover:bg-blue-600">
                                            <i class="fas fa-text mr-1"></i>OCR识别
                                        </button>
                                        <button @click="renderVisualization(index, 'grounding')" 
                                                class="px-3 py-1 text-xs bg-green-500 text-white rounded hover:bg-green-600">
                                            <i class="fas fa-crosshairs mr-1"></i>2D Grounding
                                        </button>
                                        <button @click="renderVisualization(index, 'layout')" 
                                                class="px-3 py-1 text-xs bg-purple-500 text-white rounded hover:bg-purple-600">
                                            <i class="fas fa-th-large mr-1"></i>版面分析
                                        </button>
                                    </div>
                                </div>
                                
                                <!-- 可视化结果容器 -->
                                <div v-if="message.visualization" class="mt-3 pt-3 border-t border-gray-300" v-html="message.visualization"></div>
                            </div>
                        </div>
                    </div>

                    <!-- 输入区域 -->
                    <div class="bg-white rounded-lg shadow-md p-6">
                        <label class="block text-sm font-medium text-gray-700 mb-2">
                            {{ conversationHistory.length > 0 ? '继续对话' : '用户提示词' }}
                        </label>
                        <textarea v-model="userPrompt" rows="6" 
                                  :placeholder="conversationHistory.length > 0 ? '继续您的问题...' : '输入您的问题或提示词...'"
                                  class="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500"></textarea>
                        <div class="mt-4">
                            <label class="block text-xs font-medium text-gray-700 mb-1">可选：上传图片（VL模型）</label>
                            <input type="file" accept="image/*" @change="onImageChange" />
                            <div v-if="imagePreview" class="mt-2">
                                <img :src="imagePreview" alt="图片预览" class="max-h-32 rounded border" />
                            </div>
                        </div>
                        <div class="mt-4 flex space-x-4">
                            <button @click="sendMessage" :disabled="loading || !selectedModelId"
                                    class="flex-1 bg-blue-600 text-white px-6 py-3 rounded-lg hover:bg-blue-700 disabled:opacity-50 disabled:cursor-not-allowed">
                                <i :class="streamMode ? 'fas fa-stream' : 'fas fa-paper-plane'" class="mr-2"></i>
                                {{ loading ? (streamMode ? '流式输出中...' : '发送中...') : (conversationHistory.length > 0 ? '继续' : '发送') }}
                            </button>
                            <button @click="clearAll" :disabled="loading"
                                    class="px-6 py-3 bg-gray-200 text-gray-700 rounded-lg hover:bg-gray-300 disabled:opacity-50">
                                <i class="fas fa-eraser mr-2"></i>清空
                            </button>
                        </div>
                        
                        <!-- 流式模式提示 -->
                        <div v-if="streamMode" class="mt-2 text-xs text-blue-600 flex items-center">
                            <i class="fas fa-info-circle mr-1"></i>
                            已启用流式输出模式，将实时显示模型响应
                        </div>
                    </div>

                    <!-- 流式输出实时显示 -->
                    <div v-if="loading && streamMode && response" class="bg-white rounded-lg shadow-md p-6">
                        <div class="flex items-center justify-between mb-4">
                            <h3 class="text-lg font-bold text-gray-800">
                                <i class="fas fa-stream text-blue-600 mr-2 animate-pulse"></i>实时输出
                            </h3>
                            <div class="flex items-center text-sm text-gray-500">
                                <div class="flex space-x-1 mr-2">
                                    <div class="w-2 h-2 bg-blue-600 rounded-full animate-bounce"></div>
                                    <div class="w-2 h-2 bg-blue-600 rounded-full animate-bounce" style="animation-delay: 0.1s"></div>
                                    <div class="w-2 h-2 bg-blue-600 rounded-full animate-bounce" style="animation-delay: 0.2s"></div>
                                </div>
                                生成中...
                            </div>
                        </div>
                        <div class="bg-gray-50 rounded-lg p-4 max-h-96 overflow-y-auto">
                            <pre class="whitespace-pre-wrap text-sm text-gray-800">{{ response.output }}<span class="inline-block w-2 h-4 bg-blue-600 animate-pulse ml-1"></span></pre>
                        </div>
                    </div>

                    <!-- 输出区域 -->
                    <div v-if="response && !loading" class="bg-white rounded-lg shadow-md p-6">
                        <!-- 完整输入信息 -->
                        <div class="mb-6">
                            <button @click="showRequestDetails = !showRequestDetails" 
                                    class="flex items-center justify-between w-full text-left text-lg font-bold text-gray-800 mb-2 hover:text-blue-600">
                                <span>
                                    <i class="fas fa-info-circle mr-2 text-blue-600"></i>完整请求信息
                                </span>
                                <i :class="showRequestDetails ? 'fas fa-chevron-up' : 'fas fa-chevron-down'" 
                                   class="text-sm"></i>
                            </button>
                            
                            <div v-show="showRequestDetails" class="space-y-3 mt-4 border-l-4 border-blue-500 pl-4">
                                <!-- 模型信息 -->
                                <div>
                                    <div class="text-sm font-semibold text-gray-700 mb-1">
                                        <i class="fas fa-robot mr-1"></i>模型
                                    </div>
                                    <div class="bg-blue-50 rounded p-3 text-sm">
                                        {{ getModelName(lastRequest.model_id) }}
                                    </div>
                                </div>

                                <!-- 系统提示词 -->
                                <div v-if="lastRequest.system_prompt">
                                    <div class="text-sm font-semibold text-gray-700 mb-1">
                                        <i class="fas fa-cog mr-1"></i>系统提示词
                                    </div>
                                    <div class="bg-purple-50 rounded p-3 text-sm whitespace-pre-wrap">{{ lastRequest.system_prompt }}</div>
                                </div>

                                <!-- 对话历史 -->
                                <div v-if="lastRequest.conversation_history && lastRequest.conversation_history.length > 0">
                                    <div class="text-sm font-semibold text-gray-700 mb-1">
                                        <i class="fas fa-comments mr-1"></i>对话历史 ({{ lastRequest.conversation_history.length }} 条消息)
                                    </div>
                                    <div class="bg-gray-50 rounded p-3 space-y-2 max-h-48 overflow-y-auto">
                                        <div v-for="(message, index) in lastRequest.conversation_history" :key="index"
                                             class="p-2 rounded text-sm"
                                             :class="message.role === 'user' ? 'bg-blue-50 border border-blue-200' : 'bg-green-50 border border-green-200'">
                                            <div class="font-semibold mb-1" 
                                                 :class="message.role === 'user' ? 'text-blue-700' : 'text-green-700'">
                                                {{ message.role === 'user' ? '👤 用户' : '🤖 助手' }}:
                                            </div>
                                            <div class="text-gray-700 whitespace-pre-wrap">{{ message.content }}</div>
                                        </div>
                                    </div>
                                </div>

                                <!-- 用户提示词 -->
                                <div>
                                    <div class="text-sm font-semibold text-gray-700 mb-1">
                                        <i class="fas fa-user mr-1"></i>{{ lastRequest.conversation_history && lastRequest.conversation_history.length > 0 ? '当前输入' : '用户提示词' }}
                                    </div>
                                    <div class="bg-green-50 rounded p-3 text-sm whitespace-pre-wrap">{{ lastRequest.prompt }}</div>
                                </div>

                                <!-- 选择的工具 -->
                                <div v-if="lastRequest.tool_ids && lastRequest.tool_ids.length > 0">
                                    <div class="text-sm font-semibold text-gray-700 mb-1">
                                        <i class="fas fa-wrench mr-1"></i>选择的工具
                                    </div>
                                    <div class="bg-yellow-50 rounded p-3">
                                        <div v-for="toolId in lastRequest.tool_ids" :key="toolId" 
                                             class="text-sm mb-2 last:mb-0">
                                            <span class="font-medium">{{ getToolName(toolId) }}</span>
                                            <span class="text-gray-600 ml-2">- {{ getToolDescription(toolId) }}</span>
                                        </div>
                                    </div>
                                </div>

                                <!-- 参数 -->
                                <div>
                                    <div class="text-sm font-semibold text-gray-700 mb-1">
                                        <i class="fas fa-sliders-h mr-1"></i>参数
                                    </div>
                                    <div class="bg-gray-50 rounded p-3 text-sm">
                                        <div class="grid grid-cols-3 gap-2">
                                            <div>Temperature: <span class="font-semibold">{{ lastRequest.params.temperature }}</span></div>
                                            <div>Max Tokens: <span class="font-semibold">{{ lastRequest.params.max_tokens }}</span></div>
                                            <div>Top P: <span class="font-semibold">{{ lastRequest.params.top_p }}</span></div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <h3 class="text-lg font-bold text-gray-800 mb-4">
                            <i class="fas fa-comment-dots mr-2 text-green-600"></i>模型响应
                        </h3>
                        
                        <!-- 文本输出 -->
                        <div v-if="response.output" 
                             class="bg-gray-50 rounded-lg p-4 mb-4"
                             :class="{'bg-blue-50 border border-blue-200': response.output.includes('🔧 工具调用')}">
                            <div v-if="response.output.includes('🔧 工具调用')" class="mb-2">
                                <span class="inline-block px-2 py-1 bg-blue-600 text-white text-xs rounded">
                                    <i class="fas fa-tools mr-1"></i>工具调用摘要
                                </span>
                            </div>
                            <div class="whitespace-pre-wrap">{{ response.output }}</div>
                        </div>
                        <div v-else-if="response.tool_calls && response.tool_calls.length > 0"
                             class="bg-blue-50 rounded-lg p-4 mb-4 text-gray-600 italic">
                            模型没有返回文本，仅请求了工具调用（见下方详情）
                        </div>
                        <div v-else class="bg-gray-50 rounded-lg p-4 mb-4 text-gray-400 italic">
                            无输出
                        </div>
                        
                        <!-- 工具调用信息 -->
                        <div v-if="response.tool_calls && response.tool_calls.length > 0" 
                             class="mb-4 p-4 bg-yellow-50 border border-yellow-200 rounded-lg">
                            <h4 class="text-md font-bold text-gray-800 mb-3">
                                <i class="fas fa-wrench mr-2 text-yellow-600"></i>模型请求的工具调用
                            </h4>
                            <div v-for="(call, index) in response.tool_calls" :key="index" 
                                 class="mb-3 last:mb-0 bg-white rounded border border-yellow-300">
                                <div class="flex items-center justify-between p-3 cursor-pointer hover:bg-yellow-50 rounded-t"
                                     @click="toggleToolCallDetails('response', index)">
                                    <div class="flex items-center">
                                        <i class="fas mr-2 transition-transform"
                                           :class="isToolCallExpanded('response', index) ? 'fa-chevron-down' : 'fa-chevron-right'"></i>
                                        <span class="font-semibold text-sm">{{ call.function.name }}</span>
                                        <span class="ml-2 text-xs text-gray-500">({{ call.type }})</span>
                                    </div>
                                    <span class="text-gray-500 text-xs">
                                        <i class="fas fa-eye mr-1"></i>{{ isToolCallExpanded('response', index) ? '收起' : '展开' }}详情
                                    </span>
                                </div>
                                <div v-show="isToolCallExpanded('response', index)" class="p-3 border-t border-yellow-200">
                                    <div class="text-xs text-gray-600 mb-2">调用ID: <code class="bg-gray-100 px-1 rounded">{{ call.id }}</code></div>
                                    <div class="text-sm">
                                        <div class="font-medium text-gray-700 mb-1">参数:</div>
                                        <pre class="bg-gray-50 p-3 rounded text-xs overflow-x-auto max-h-96 overflow-y-auto border border-gray-200">{{ formatJson(call.function.arguments) }}</pre>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- 性能指标 -->
                        <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mt-4 pt-4 border-t">
                            <div class="text-center">
                                <div class="text-2xl font-bold text-blue-600">{{ response.metrics.response_time?.toFixed(2) }}s</div>
                                <div class="text-sm text-gray-600">响应时间</div>
                            </div>
                            <div class="text-center">
                                <div class="text-2xl font-bold text-green-600">{{ response.metrics.total_tokens }}</div>
                                <div class="text-sm text-gray-600">总Tokens</div>
                            </div>
                            <div class="text-center">
                                <div class="text-2xl font-bold text-purple-600">
                                    ${{ response.metrics.estimated_cost?.toFixed(4) }}
                                </div>
                                <div class="text-sm text-gray-600">估算成本</div>
                            </div>
                            <div class="text-center">
                                <div class="text-2xl font-bold"
                                     :class="response.status === 'success' ? 'text-green-600' : 'text-red-600'">
                                    <i :class="response.status === 'success' ? 'fas fa-check-circle' : 'fas fa-times-circle'"></i>
                                </div>
                                <div class="text-sm text-gray-600">状态</div>
                            </div>
                        </div>

                        <!-- 错误信息 -->
                        <div v-if="response.error_message" 
                             class="mt-4 p-4 bg-red-50 border border-red-200 rounded-lg text-red-700">
                            <i class="fas fa-exclamation-triangle mr-2"></i>
                            {{ response.error_message }}
                        </div>
                        
                        <!-- 保存为测试用例按钮 -->
                        <div v-if="response.status === 'success'" class="mt-6 pt-4 border-t">
                            <button @click="showSaveTestCaseModal = true"
                                    class="w-full bg-gradient-to-r from-blue-600 to-purple-600 text-white px-6 py-3 rounded-lg hover:from-blue-700 hover:to-purple-700 transition-all shadow-md hover:shadow-lg">
                                <i class="fas fa-save mr-2"></i>保存为测试用例
                            </button>
                            <p class="text-xs text-gray-500 text-center mt-2">
                                <i class="fas fa-info-circle mr-1"></i>将当前对话和结果保存为可复用的测试用例
                            </p>
                        </div>
                    </div>
                </div>
            </div>
        </main>
        
        <!-- 保存测试用例模态框 -->
        <div v-if="showSaveTestCaseModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
            <div class="bg-white rounded-lg shadow-xl w-full max-w-2xl max-h-screen overflow-y-auto m-4">
                <div class="p-6 border-b sticky top-0 bg-white z-10">
                    <div class="flex items-center justify-between">
                        <h2 class="text-2xl font-bold text-gray-800">
                            <i class="fas fa-save mr-2 text-blue-600"></i>保存为测试用例
                        </h2>
                        <button @click="showSaveTestCaseModal = false" class="text-gray-400 hover:text-gray-600">
                            <i class="fas fa-times text-2xl"></i>
                        </button>
                    </div>
                </div>
                
                <form @submit.prevent="saveAsTestCase" class="p-6 space-y-4">
                    <!-- 标题 -->
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">
                            测试用例标题 *
                        </label>
                        <input v-model="testCaseForm.title" required
                               placeholder="例如：测试上下文记忆能力"
                               class="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500">
                    </div>
                    
                    <!-- 分类和标签 -->
                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">分类</label>
                            <input v-model="testCaseForm.category"
                                   placeholder="例如：对话能力"
                                   class="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">标签</label>
                            <input v-model="testCaseForm.tags"
                                   placeholder="用逗号分隔，例如：多轮,记忆"
                                   class="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500">
                        </div>
                    </div>
                    
                    <!-- 期望结果类型选择 -->
                    <div class="bg-gray-50 rounded-lg p-4 border border-gray-200">
                        <label class="block text-sm font-medium text-gray-700 mb-3">
                            <i class="fas fa-bullseye mr-1"></i>期望结果配置（用于自动评分）
                        </label>
                        
                        <!-- 实际模型响应 -->
                        <div class="mb-3 p-3 bg-white border border-gray-300 rounded">
                            <div class="text-xs font-semibold text-gray-700 mb-2">
                                <i class="fas fa-info-circle mr-1"></i>本次模型响应：
                            </div>
                            <div class="space-y-2">
                                <div v-if="response.output" class="text-xs">
                                    <span class="font-medium text-gray-600">文本输出：</span>
                                    <div class="bg-gray-50 p-2 rounded mt-1 max-h-24 overflow-y-auto">
                                        <pre class="whitespace-pre-wrap text-gray-700">{{ response.output.substring(0, 200) }}{{ response.output.length > 200 ? '...' : '' }}</pre>
                                    </div>
                                </div>
                                <div v-if="response.tool_calls && response.tool_calls.length > 0" class="text-xs">
                                    <span class="font-medium text-gray-600">工具调用：</span>
                                    <div class="bg-yellow-50 p-2 rounded mt-1">
                                        <div v-for="(call, idx) in response.tool_calls" :key="idx" class="mb-1 last:mb-0">
                                            <span class="font-medium">{{ call.function.name }}</span>
                                            <span class="text-gray-500 ml-1">({{ typeof call.function.arguments === 'string' ? call.function.arguments.substring(0, 50) : JSON.stringify(call.function.arguments).substring(0, 50) }}...)</span>
                                        </div>
                                    </div>
                                </div>
                                <div v-if="!response.output && (!response.tool_calls || response.tool_calls.length === 0)" class="text-xs text-gray-400 italic">
                                    无输出
                                </div>
                            </div>
                        </div>
                        
                        <!-- 快速填充按钮 -->
                        <div class="flex gap-2 mb-3">
                            <button type="button" @click="fillExpectedOutput"
                                    :disabled="!response.output"
                                    class="flex-1 px-3 py-2 bg-blue-100 text-blue-700 rounded hover:bg-blue-200 text-sm disabled:opacity-50 disabled:cursor-not-allowed">
                                <i class="fas fa-file-alt mr-1"></i>使用文本输出作为期望
                            </button>
                            <button type="button" @click="fillExpectedToolCalls"
                                    v-if="response.tool_calls && response.tool_calls.length > 0"
                                    class="flex-1 px-3 py-2 bg-yellow-100 text-yellow-700 rounded hover:bg-yellow-200 text-sm">
                                <i class="fas fa-wrench mr-1"></i>使用工具调用作为期望
                            </button>
                        </div>
                        
                        <!-- 期望输出 -->
                        <div class="mb-3">
                            <label class="block text-xs font-medium text-gray-600 mb-1">
                                期望输出（文本内容）
                            </label>
                            <textarea v-model="testCaseForm.expected_output" rows="3"
                                      placeholder="可选，填写期望的模型输出内容..."
                                      class="w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500 text-sm"></textarea>
                        </div>
                        
                        <!-- 期望工具调用 -->
                        <div>
                            <label class="block text-xs font-medium text-gray-600 mb-1">
                                期望工具调用（JSON格式）
                            </label>
                            <textarea v-model="testCaseForm.expected_tool_calls" rows="4"
                                      placeholder='可选，例如：[{"function": {"name": "get_weather", "arguments": {"city": "北京"}}}]'
                                      class="w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500 font-mono text-sm"></textarea>
                        </div>
                        
                        <p class="text-xs text-gray-500 mt-2">
                            <i class="fas fa-lightbulb mr-1"></i>提示：两者都可以留空，仅保存对话记录。也可以同时填写，用于综合评分。
                        </p>
                    </div>
                    
                    <!-- 预览信息 -->
                    <div class="bg-blue-50 border border-blue-200 rounded-lg p-4">
                        <h3 class="text-sm font-semibold text-blue-800 mb-3">
                            <i class="fas fa-eye mr-1"></i>将要保存的内容
                        </h3>
                        <div class="space-y-2 text-sm">
                            <div v-if="lastRequest.system_prompt">
                                <span class="font-medium text-gray-700">系统提示词：</span>
                                <span class="text-gray-600">已包含</span>
                            </div>
                            <div v-if="conversationHistory.length > 2">
                                <span class="font-medium text-gray-700">历史对话上下文：</span>
                                <span class="text-gray-600">{{ conversationHistory.length - 2 }} 条消息（不包括当前轮）</span>
                            </div>
                            <div v-else-if="conversationHistory.length === 2">
                                <span class="font-medium text-gray-700">对话类型：</span>
                                <span class="text-gray-600">单轮对话</span>
                            </div>
                            <div>
                                <span class="font-medium text-gray-700">当前提示词：</span>
                                <span class="text-gray-600">{{ lastRequest.prompt.substring(0, 50) }}...</span>
                            </div>
                            <div v-if="lastRequest.tool_ids && lastRequest.tool_ids.length > 0">
                                <span class="font-medium text-gray-700">关联工具：</span>
                                <span class="text-gray-600">{{ lastRequest.tool_ids.length }} 个</span>
                            </div>
                            <div v-if="response.tool_calls && response.tool_calls.length > 0" class="pt-2 border-t border-blue-300">
                                <span class="font-medium text-gray-700">实际工具调用：</span>
                                <span class="text-gray-600">{{ response.tool_calls.length }} 个</span>
                            </div>
                            <div v-if="testCaseForm.expected_output" class="pt-2 border-t border-blue-300">
                                <span class="font-medium text-gray-700">期望输出：</span>
                                <span class="text-gray-600">已设置 ({{ testCaseForm.expected_output.length }} 字符)</span>
                            </div>
                            <div v-if="testCaseForm.expected_tool_calls" class="pt-2 border-t border-blue-300">
                                <span class="font-medium text-gray-700">期望工具调用：</span>
                                <span class="text-gray-600">已设置</span>
                            </div>
                        </div>
                    </div>
                    
                    <!-- 按钮组 -->
                    <div class="flex space-x-4 pt-4">
                        <button type="submit" :disabled="savingTestCase"
                                class="flex-1 bg-blue-600 text-white px-6 py-3 rounded-lg hover:bg-blue-700 disabled:opacity-50 disabled:cursor-not-allowed">
                            <i class="fas" :class="savingTestCase ? 'fa-spinner fa-spin' : 'fa-check'" class="mr-2"></i>
                            {{ savingTestCase ? '保存中...' : '确认保存' }}
                        </button>
                        <button type="button" @click="showSaveTestCaseModal = false" :disabled="savingTestCase"
                                class="px-6 py-3 bg-gray-200 text-gray-700 rounded-lg hover:bg-gray-300 disabled:opacity-50">
                            <i class="fas fa-times mr-2"></i>取消
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <script src="/assets/js/utils/api.js"></script>
    <script>
        const { createApp } = Vue;

        createApp({
            data() {
                return {
                    models: [],
                    availableTools: [],  // 可用工具列表
                    selectedModelId: '',
                    selectedTools: [],  // 选中的工具ID列表
                    useMock: false,  // 是否使用模拟工具执行
                    systemPrompt: '',
                    systemPrompts: [],  // 系统提示词模板列表
                    selectedPromptId: '',  // 选中的提示词ID
                    userPrompt: '',
                    conversationHistory: [],  // 对话历史
                    streamMode: false,  // 流式输出模式
                    streamingText: '',  // 流式输出的文本
                    params: {
                        temperature: 0.7,
                        top_p: 1.0,
                        max_tokens: 1000
                    },
                    response: null,
                    imageFile: null, // 新增：图片文件
                    imagePreview: '', // 新增：图片预览
                    lastRequest: null,  // 保存最后一次请求的完整信息
                    showRequestDetails: true,  // 默认展开请求详情
                    expandedToolCalls: {},  // 展开的工具调用详情 {messageIndex-callIndex: true}
                    loading: false,
                    history: [],
                    showSaveTestCaseModal: false,  // 保存测试用例模态框
                    savingTestCase: false,  // 保存中状态
                    testCaseForm: {  // 测试用例表单
                        title: '',
                        category: '',
                        tags: '',
                        expected_output: '',
                        expected_tool_calls: ''
                    }
                }
            },
            computed: {
                // 按分类分组的提示词
                groupedPrompts() {
                    const grouped = {};
                    this.systemPrompts.forEach(prompt => {
                        const category = prompt.category || '未分类';
                        if (!grouped[category]) {
                            grouped[category] = [];
                        }
                        grouped[category].push(prompt);
                    });
                    return grouped;
                }
            },
            async mounted() {
                await this.loadModels();
                await this.loadTools();
                await this.loadSystemPrompts();
                this.loadHistoryFromStorage();
            },
            methods: {
                async loadSystemPrompts() {
                    try {
                        this.systemPrompts = await api.get('/api/system-prompts/');
                    } catch (error) {
                        console.error('加载系统提示词失败:', error);
                    }
                },
                loadSelectedPrompt() {
                    if (this.selectedPromptId) {
                        const prompt = this.systemPrompts.find(p => p.id === parseInt(this.selectedPromptId));
                        if (prompt) {
                            this.systemPrompt = prompt.content;
                        }
                    }
                },
                onImageChange(e) {
                    const file = e.target.files[0];
                    if (file) {
                        this.imageFile = file;
                        this.imagePreview = URL.createObjectURL(file);
                    } else {
                        this.imageFile = null;
                        this.imagePreview = '';
                    }
                },
                async loadTools() {
                    try {
                        this.availableTools = await api.get('/api/tools/');
                    } catch (error) {
                        console.error('加载工具列表失败:', error);
                    }
                },
                async loadModels() {
                    try {
                        this.models = await api.get('/api/models');
                        // 默认选择第一个模型
                        if (this.models.length > 0 && !this.selectedModelId) {
                            this.selectedModelId = this.models[0].id;
                        }
                    } catch (error) {
                        alert('加载模型失败: ' + error.message);
                    }
                },
                async sendMessage() {
                    if (!this.userPrompt.trim() && !this.imageFile) {
                        alert('请输入提示词或上传图片');
                        return;
                    }

                    this.loading = true;
                    this.response = null;
                    this.streamingText = '';

                    try {
                        let content;
                        
                        // 如果有图片，使用数组格式
                        if (this.imageFile) {
                            let contentArr = [];
                            if (this.userPrompt.trim()) {
                                contentArr.push({ type: 'text', text: this.userPrompt });
                            }
                            const toBase64 = file => new Promise((resolve, reject) => {
                                const reader = new FileReader();
                                reader.onload = () => resolve(reader.result.split(',')[1]);
                                reader.onerror = reject;
                                reader.readAsDataURL(file);
                            });
                            const base64 = await toBase64(this.imageFile);
                            contentArr.push({ type: 'image_url', image_url: { url: `data:${this.imageFile.type};base64,${base64}` } });
                            content = contentArr;
                        } else {
                            // 没有图片，使用简单字符串格式
                            content = this.userPrompt.trim();
                        }

                        const requestData = {
                            model_id: parseInt(this.selectedModelId),
                            content: content,
                            system_prompt: this.systemPrompt || null,
                            params: this.params,
                            tool_ids: this.selectedTools.length > 0 ? this.selectedTools : null,
                            conversation_history: this.conversationHistory.length > 0 ? this.conversationHistory : null,
                            use_mock: this.useMock,
                            stream: this.streamMode
                        };

                        // 保存当前用户输入到对话历史（使用统一的content变量）
                        const currentUserMessage = content;

                        // 保存请求信息
                        this.lastRequest = JSON.parse(JSON.stringify(requestData));

                        if (this.streamMode) {
                            await this.sendStreamMessage(requestData);
                        } else {
                            this.response = await api.post('/api/debug/chat', requestData);
                        }

                        if (this.response && this.response.status === 'success') {
                            this.conversationHistory.push({
                                role: 'user',
                                content: currentUserMessage
                            });

                            const assistantMessage = {
                                role: 'assistant',
                                content: this.response.output || ''
                            };
                            if (this.response.tool_calls && this.response.tool_calls.length > 0) {
                                assistantMessage.tool_calls = this.response.tool_calls;
                            }
                            this.conversationHistory.push(assistantMessage);
                            this.userPrompt = '';
                            this.imageFile = null;
                            this.imagePreview = '';
                        }
                        if (this.response) {
                            this.saveToHistory();
                        }
                    } catch (error) {
                        alert('请求失败: ' + error.message);
                    } finally {
                        this.loading = false;
                    }
                },
                async sendStreamMessage(requestData) {
                    const apiBase = window.location.origin;
                    const response = await fetch(`${apiBase}/api/debug/chat`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify(requestData)
                    });

                    if (!response.ok) {
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }

                    const reader = response.body.getReader();
                    const decoder = new TextDecoder();
                    let buffer = '';
                    
                    // 初始化响应对象
                    this.response = {
                        status: 'success',
                        output: '',
                        tool_calls: [],
                        metrics: {
                            prompt_tokens: 0,
                            completion_tokens: 0,
                            total_tokens: 0,
                            response_time: 0,
                            estimated_cost: 0
                        }
                    };

                    while (true) {
                        const { done, value } = await reader.read();
                        if (done) break;

                        buffer += decoder.decode(value, { stream: true });
                        const lines = buffer.split('\n');
                        buffer = lines.pop() || '';

                        for (const line of lines) {
                            if (line.startsWith('data: ')) {
                                const data = line.slice(6);
                                if (data === '[DONE]') {
                                    continue;
                                }
                                
                                try {
                                    const chunk = JSON.parse(data);
                                    
                                    // 处理文本内容
                                    if (chunk.content) {
                                        this.response.output += chunk.content;
                                    }
                                    
                                    // 处理工具调用
                                    if (chunk.tool_calls) {
                                        this.response.tool_calls = chunk.tool_calls;
                                    }
                                    
                                    // 更新指标
                                    if (chunk.metrics) {
                                        Object.assign(this.response.metrics, chunk.metrics);
                                    }
                                    
                                    // 处理完成信号
                                    if (chunk.done) {
                                        if (chunk.final_response) {
                                            // 使用最终响应替换
                                            this.response = chunk.final_response;
                                        }
                                    }
                                } catch (e) {
                                    console.error('解析流式数据失败:', e, data);
                                }
                            }
                        }
                    }
                },
                clearAll() {
                    this.userPrompt = '';
                    this.systemPrompt = '';
                    this.response = null;
                    this.lastRequest = null;
                    this.conversationHistory = [];  // 清空对话历史
                },
                clearConversation() {
                    if (confirm('确定要清空对话历史吗？')) {
                        this.conversationHistory = [];
                    }
                },
                fillExpectedOutput() {
                    // 使用模型的最后一次输出作为期望输出
                    if (this.response && this.response.output) {
                        this.testCaseForm.expected_output = this.response.output;
                    } else {
                        alert('当前没有可用的模型输出');
                    }
                },
                fillExpectedToolCalls() {
                    // 使用模型的工具调用作为期望工具调用
                    if (this.response && this.response.tool_calls && this.response.tool_calls.length > 0) {
                        // 格式化为易读的JSON
                        this.testCaseForm.expected_tool_calls = JSON.stringify(this.response.tool_calls, null, 2);
                    } else {
                        alert('当前没有可用的工具调用信息');
                    }
                },
                async saveAsTestCase() {
                    if (!this.testCaseForm.title.trim()) {
                        alert('请输入测试用例标题');
                        return;
                    }
                    
                    this.savingTestCase = true;
                    
                    try {
                        // 解析 expected_tool_calls (如果有的话)
                        let expectedToolCalls = null;
                        if (this.testCaseForm.expected_tool_calls && this.testCaseForm.expected_tool_calls.trim()) {
                            try {
                                expectedToolCalls = JSON.parse(this.testCaseForm.expected_tool_calls);
                            } catch (e) {
                                alert('期望工具调用的 JSON 格式不正确: ' + e.message);
                                return;
                            }
                        }
                        
                        // 处理对话历史
                        // 当前轮的输入已经在 lastRequest.prompt 中
                        // 对话历史应该只包含之前的轮次，不包括当前轮
                        let conversationHistoryToSave = null;
                        
                        if (this.conversationHistory.length > 2) {
                            // 多轮对话：去掉最后两条（当前轮的用户输入和助手回复）
                            conversationHistoryToSave = this.conversationHistory.slice(0, -2);
                        }
                        // 如果只有2条或更少，说明是单轮对话，不保存历史
                        
                        // 构建测试用例数据
                        const testCaseData = {
                            title: this.testCaseForm.title,
                            category: this.testCaseForm.category || null,
                            tags: this.testCaseForm.tags || null,
                            system_prompt: this.lastRequest.system_prompt || null,
                            conversation_history: conversationHistoryToSave,
                            prompt: this.lastRequest.prompt,
                            expected_output: this.testCaseForm.expected_output || null,
                            expected_tool_calls: expectedToolCalls,
                            tools: this.lastRequest.tool_ids || [],
                            meta_data: {
                                created_from: 'debug_page',
                                model_used: this.getModelName(this.lastRequest.model_id),
                                params: this.lastRequest.params,
                                actual_output: this.response.output,
                                actual_tool_calls: this.response.tool_calls || null,
                                response_time: this.response.metrics.response_time,
                                tokens: this.response.metrics.total_tokens
                            }
                        };
                        
                        // 调用API保存
                        const result = await api.post('/api/testcases', testCaseData);
                        
                        // 成功提示
                        this.showSaveTestCaseModal = false;
                        
                        // 询问是否跳转
                        if (confirm('测试用例保存成功！是否跳转到测试用例页面查看？')) {
                            window.location.href = '/pages/testcases.html';
                        } else {
                            // 重置表单
                            this.testCaseForm = {
                                title: '',
                                category: '',
                                tags: '',
                                expected_output: '',
                                expected_tool_calls: ''
                            };
                            
                            // 显示成功消息
                            alert('测试用例已保存！');
                        }
                    } catch (error) {
                        alert('保存失败: ' + error.message);
                    } finally {
                        this.savingTestCase = false;
                    }
                },
                saveToHistory() {
                    const item = {
                        timestamp: new Date().toISOString(),
                        model_id: this.selectedModelId,
                        prompt: this.userPrompt,
                        system_prompt: this.systemPrompt,
                        response: this.response,
                        lastRequest: this.lastRequest
                    };
                    this.history.unshift(item);
                    // Limit to 10 items to avoid storage quota issues
                    if (this.history.length > 10) {
                        this.history = this.history.slice(0, 10);
                    }
                    
                    // Save to localStorage with error handling
                    try {
                        // Store only essential data to avoid quota exceeded
                        const lightHistory = this.history.map(h => ({
                            timestamp: h.timestamp,
                            model_id: h.model_id,
                            prompt: h.prompt.substring(0, 200), // Truncate long prompts
                            system_prompt: h.system_prompt ? h.system_prompt.substring(0, 200) : '',
                            output: h.response?.output ? h.response.output.substring(0, 500) : '' // Store summary only
                        }));
                        localStorage.setItem('debug_history', JSON.stringify(lightHistory));
                    } catch (e) {
                        console.warn('Failed to save history to localStorage:', e);
                        // If quota exceeded, clear old history and try again with smaller dataset
                        if (e.name === 'QuotaExceededError') {
                            this.history = this.history.slice(0, 5);
                            try {
                                const lightHistory = this.history.map(h => ({
                                    timestamp: h.timestamp,
                                    model_id: h.model_id,
                                    prompt: h.prompt.substring(0, 100),
                                    system_prompt: '',
                                    output: ''
                                }));
                                localStorage.setItem('debug_history', JSON.stringify(lightHistory));
                            } catch (e2) {
                                // If still fails, clear all history
                                localStorage.removeItem('debug_history');
                                this.history = [];
                            }
                        }
                    }
                },
                loadHistoryFromStorage() {
                    try {
                        const stored = localStorage.getItem('debug_history');
                        if (stored) {
                            this.history = JSON.parse(stored);
                        }
                    } catch (e) {
                        console.warn('Failed to load history from localStorage:', e);
                        localStorage.removeItem('debug_history');
                        this.history = [];
                    }
                },
                loadHistory(item) {
                    this.selectedModelId = item.model_id;
                    this.userPrompt = item.prompt;
                    this.systemPrompt = item.system_prompt || '';
                    // Note: History only stores summary, full response not available
                    this.response = item.response || null;
                    this.lastRequest = item.lastRequest || null;
                },
                formatTime(timestamp) {
                    const date = new Date(timestamp);
                    return date.toLocaleString('zh-CN');
                },
                getModelName(modelId) {
                    const model = this.models.find(m => m.id === modelId);
                    return model ? `${model.name} (${model.model_name})` : '未知模型';
                },
                getToolName(toolId) {
                    const tool = this.availableTools.find(t => t.id === toolId);
                    return tool ? tool.name : `工具 #${toolId}`;
                },
                getToolDescription(toolId) {
                    const tool = this.availableTools.find(t => t.id === toolId);
                    return tool ? tool.description : '';
                },
                formatJson(str) {
                    try {
                        const obj = typeof str === 'string' ? JSON.parse(str) : str;
                        return JSON.stringify(obj, null, 2);
                    } catch (e) {
                        return str;
                    }
                },
                // 切换工具调用详情的展开/折叠状态
                toggleToolCallDetails(messageIndex, callIndex) {
                    const key = `${messageIndex}-${callIndex}`;
                    this.expandedToolCalls[key] = !this.expandedToolCalls[key];
                },
                // 检查工具调用详情是否展开
                isToolCallExpanded(messageIndex, callIndex) {
                    const key = `${messageIndex}-${callIndex}`;
                    return this.expandedToolCalls[key] || false;
                },
                // 检查对话中是否包含图片
                hasImageInConversation(assistantIndex) {
                    if (assistantIndex > 0) {
                        const userMessage = this.conversationHistory[assistantIndex - 1];
                        if (userMessage && userMessage.content && Array.isArray(userMessage.content)) {
                            return userMessage.content.some(item => item.type === 'image_url');
                        }
                    }
                    return false;
                },
                // 渲染可视化结果
                async renderVisualization(messageIndex, type) {
                    const message = this.conversationHistory[messageIndex];
                    if (!message || message.role !== 'assistant') return;
                    
                    // 获取对应的用户消息中的图片
                    let imageBase64 = null;
                    if (messageIndex > 0) {
                        const userMessage = this.conversationHistory[messageIndex - 1];
                        if (userMessage && userMessage.content && Array.isArray(userMessage.content)) {
                            const imageItem = userMessage.content.find(item => item.type === 'image_url');
                            if (imageItem) {
                                imageBase64 = imageItem.image_url.url;
                            }
                        }
                    }
                    
                    if (!imageBase64) {
                        alert('未找到对应的图片数据');
                        return;
                    }
                    
                    const response = message.content;
                    let visualizationHtml = '';
                    
                    try {
                        if (type === 'ocr') {
                            visualizationHtml = await this.generateOCRVisualization(imageBase64, response);
                        } else if (type === 'grounding') {
                            visualizationHtml = await this.generateGroundingVisualization(imageBase64, response);
                        } else if (type === 'layout') {
                            visualizationHtml = await this.generateLayoutVisualization(imageBase64, response);
                        }
                        
                        // 更新可视化结果 (Vue 3 方式)
                        message.visualization = visualizationHtml;
                    } catch (error) {
                        alert('可视化失败: ' + error.message);
                    }
                },
                // 生成OCR可视化HTML
                async generateOCRVisualization(imageBase64, response) {
                    // 解析OCR数据
                    let ocrData = [];
                    let hasStructuredData = false;
                    let formattedResponse = response;
                    
                    try {
                        const jsonMatch = response.match(/\{[\s\S]*\}|\[[\s\S]*\]/);
                        if (jsonMatch) {
                            const jsonObj = JSON.parse(jsonMatch[0]);
                            formattedResponse = JSON.stringify(jsonObj, null, 2);
                            
                            if (Array.isArray(jsonObj)) {
                                hasStructuredData = jsonObj.some(item => item.bbox_2d && item.text_content);
                                if (hasStructuredData) {
                                    ocrData = jsonObj;
                                }
                            }
                        }
                    } catch (e) {
                        console.log('无法解析OCR数据:', e);
                    }
                    
                    if (!hasStructuredData || ocrData.length === 0) {
                        // 返回简单文本显示
                        return `
                            <div class="mm-result-container">
                                <h4 class="font-bold mb-2"><i class="fas fa-check-circle text-green-600 mr-1"></i>OCR识别结果</h4>
                                <div class="p-4 bg-white rounded border max-h-96 overflow-y-auto">
                                    <pre class="text-sm text-gray-700 whitespace-pre-wrap">${this.escapeHtml(formattedResponse)}</pre>
                                </div>
                            </div>
                        `;
                    }
                    
                    // 生成可视化HTML
                    const canvasId = 'ocr-canvas-viz-' + Date.now();
                    const html = `
                        <div class="mm-result-container">
                            <h4 class="font-bold mb-2"><i class="fas fa-check-circle text-green-600 mr-1"></i>OCR识别完成</h4>
                            <div class="mb-2 text-sm text-green-600">
                                <i class="fas fa-info-circle mr-1"></i>识别到 ${ocrData.length} 个文本块
                            </div>
                            <div class="grid grid-cols-1 lg:grid-cols-2 gap-4">
                                <div>
                                    <h5 class="font-semibold mb-2">可视化结果：</h5>
                                    <canvas id="${canvasId}" style="border:1px solid #ddd; border-radius:8px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); max-width:100%;"></canvas>
                                </div>
                                <div>
                                    <h5 class="font-semibold mb-2">识别文本列表：</h5>
                                    <div class="p-4 bg-white rounded border max-h-96 overflow-y-auto">
                                        ${ocrData.map((item, i) => {
                                            const color = this.getColorForIndex(i);
                                            return `
                                                <div class="mm-text-block" style="border-left-color:${color};">
                                                    <div class="text-xs text-gray-500 mb-1">区域 ${i+1} [${item.bbox_2d.join(', ')}]</div>
                                                    <div class="text-sm">${this.escapeHtml(item.text_content)}</div>
                                                </div>
                                            `;
                                        }).join('')}
                                    </div>
                                </div>
                            </div>
                            <div class="mt-4 p-4 bg-gray-50 rounded border">
                                <details>
                                    <summary class="font-semibold cursor-pointer">原始JSON数据</summary>
                                    <pre class="text-sm text-gray-700 whitespace-pre-wrap mt-2">${this.escapeHtml(formattedResponse)}</pre>
                                </details>
                            </div>
                        </div>
                    `;
                    
                    // 延迟绘制canvas
                    setTimeout(() => this.drawOCROnCanvas(canvasId, imageBase64, ocrData), 100);
                    
                    return html;
                },
                // 生成2D Grounding可视化HTML
                async generateGroundingVisualization(imageBase64, response) {
                    // 解析Grounding数据
                    let bboxes = [];
                    try {
                        const jsonMatch = response.match(/\[\s*\[[\d,\s\[\]"'a-zA-Z\u4e00-\u9fa5]+\]\s*\]/);
                        if (jsonMatch) {
                            bboxes = JSON.parse(jsonMatch[0]);
                        }
                    } catch (e) {
                        console.log('无法解析Grounding数据:', e);
                    }
                    
                    const hasValidBboxes = bboxes.length > 0 && Array.isArray(bboxes[0]);
                    const canvasId = 'grounding-canvas-viz-' + Date.now();
                    
                    if (!hasValidBboxes) {
                        return `
                            <div class="mm-result-container">
                                <h4 class="font-bold mb-2"><i class="fas fa-check-circle text-green-600 mr-1"></i>2D Grounding结果</h4>
                                <div class="mm-canvas-container">
                                    <img src="${imageBase64}" class="mm-image-preview" alt="检测结果" />
                                </div>
                                <div class="mt-4 p-4 bg-gray-50 rounded border">
                                    <pre class="text-sm text-gray-700 whitespace-pre-wrap">${this.escapeHtml(response)}</pre>
                                </div>
                            </div>
                        `;
                    }
                    
                    const html = `
                        <div class="mm-result-container">
                            <h4 class="font-bold mb-2"><i class="fas fa-check-circle text-green-600 mr-1"></i>检测完成</h4>
                            <div class="mb-2 text-sm text-green-600">
                                <i class="fas fa-info-circle mr-1"></i>检测到 ${bboxes.length} 个目标
                            </div>
                            <div style="position:relative; display:inline-block;">
                                <canvas id="${canvasId}" style="border:1px solid #ddd; border-radius:8px; box-shadow: 0 2px 8px rgba(0,0,0,0.1);"></canvas>
                            </div>
                            <div class="mt-4 p-4 bg-white rounded border">
                                <h5 class="font-semibold mb-2">检测结果列表：</h5>
                                <ul class="space-y-1">
                                    ${bboxes.map((bbox, i) => {
                                        const label = bbox.length > 4 ? bbox[4] : '目标' + (i+1);
                                        const color = this.getColorForIndex(i);
                                        return `<li class="text-sm"><span class="inline-block w-4 h-4 mr-2" style="background:${color};"></span>${this.escapeHtml(label)}: [${bbox.slice(0,4).join(', ')}]</li>`;
                                    }).join('')}
                                </ul>
                            </div>
                            <div class="mt-4 p-4 bg-gray-50 rounded border">
                                <details>
                                    <summary class="font-semibold cursor-pointer">原始模型响应</summary>
                                    <pre class="text-sm text-gray-700 whitespace-pre-wrap mt-2">${this.escapeHtml(response)}</pre>
                                </details>
                            </div>
                        </div>
                    `;
                    
                    setTimeout(() => this.drawGroundingOnCanvas(canvasId, imageBase64, bboxes), 100);
                    
                    return html;
                },
                // 生成版面分析可视化HTML
                async generateLayoutVisualization(imageBase64, response) {
                    return new Promise((resolve) => {
                        const tempDiv = document.createElement('div');
                        document.body.appendChild(tempDiv);
                        tempDiv.style.display = 'none';
                        renderLayoutResult(imageBase64, response, tempDiv);
                        setTimeout(() => {
                            resolve(tempDiv.innerHTML);
                            document.body.removeChild(tempDiv);
                        }, 100);
                    });
                },
                // 辅助方法：HTML转义
                escapeHtml(text) {
                    const div = document.createElement('div');
                    div.textContent = text;
                    return div.innerHTML;
                },
                // 辅助方法：获取颜色
                getColorForIndex(index) {
                    const colors = ['#ef4444', '#3b82f6', '#10b981', '#f59e0b', '#8b5cf6', '#ec4899', '#14b8a6', '#f97316'];
                    return colors[index % colors.length];
                },
                // 辅助方法：在Canvas上绘制OCR结果
                drawOCROnCanvas(canvasId, imageBase64, ocrData) {
                    const canvas = document.getElementById(canvasId);
                    if (!canvas) {
                        console.warn('Canvas not found:', canvasId);
                        return;
                    }
                    
                    const ctx = canvas.getContext('2d');
                    const img = new Image();
                    
                    img.onload = () => {
                        const imgWidth = img.width;
                        const imgHeight = img.height;
                        
                        const maxWidth = 600;
                        let scale = 1;
                        if (imgWidth > maxWidth) {
                            scale = maxWidth / imgWidth;
                        }
                        
                        canvas.width = imgWidth * scale;
                        canvas.height = imgHeight * scale;
                        
                        console.log('OCR Canvas Info:', {
                            originalSize: [imgWidth, imgHeight],
                            canvasSize: [canvas.width, canvas.height],
                            scale: scale,
                            dataCount: ocrData.length
                        });
                        
                        ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
                        
                        ocrData.forEach((item, i) => {
                            if (item.bbox_2d && item.bbox_2d.length >= 4) {
                                let [x1, y1, x2, y2] = item.bbox_2d;
                                
                                x1 *= scale;
                                y1 *= scale;
                                x2 *= scale;
                                y2 *= scale;
                                
                                const width = x2 - x1;
                                const height = y2 - y1;
                                const color = this.getColorForIndex(i);
                                
                                console.log(`OCR Box ${i+1}:`, {
                                    original: item.bbox_2d,
                                    scaled: [x1, y1, x2, y2],
                                    size: [width, height],
                                    text: item.text_content
                                });
                                
                                ctx.fillStyle = color + '30';
                                ctx.fillRect(x1, y1, width, height);
                                
                                ctx.strokeStyle = color;
                                ctx.lineWidth = 2;
                                ctx.strokeRect(x1, y1, width, height);
                                
                                const labelSize = 16;
                                const labelX = x1 + 5;
                                const labelY = y1 + 5;
                                
                                ctx.fillStyle = color;
                                ctx.beginPath();
                                ctx.arc(labelX + labelSize/2, labelY + labelSize/2, labelSize/2, 0, 2 * Math.PI);
                                ctx.fill();
                                
                                ctx.fillStyle = 'white';
                                ctx.font = 'bold 11px Arial';
                                ctx.textAlign = 'center';
                                ctx.textBaseline = 'middle';
                                ctx.fillText((i + 1).toString(), labelX + labelSize/2, labelY + labelSize/2);
                            }
                        });
                    };
                    
                    img.src = imageBase64;
                },
                // 辅助方法：在Canvas上绘制Grounding结果
                drawGroundingOnCanvas(canvasId, imageBase64, bboxes) {
                    const canvas = document.getElementById(canvasId);
                    if (!canvas) {
                        console.warn('Canvas not found:', canvasId);
                        return;
                    }
                    
                    const ctx = canvas.getContext('2d');
                    const img = new Image();
                    
                    img.onload = () => {
                        const imgWidth = img.width;
                        const imgHeight = img.height;
                        
                        const maxWidth = 800;
                        let scale = 1;
                        if (imgWidth > maxWidth) {
                            scale = maxWidth / imgWidth;
                        }
                        
                        canvas.width = imgWidth * scale;
                        canvas.height = imgHeight * scale;
                        
                        console.log('Grounding Canvas Info:', {
                            originalSize: [imgWidth, imgHeight],
                            canvasSize: [canvas.width, canvas.height],
                            scale: scale,
                            bboxCount: bboxes.length
                        });
                        
                        ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
                        
                        bboxes.forEach((bbox, i) => {
                            if (bbox.length >= 4) {
                                let [x1, y1, x2, y2] = bbox.slice(0, 4);
                                const label = bbox.length > 4 ? bbox[4] : '目标' + (i+1);
                                const color = this.getColorForIndex(i);
                                
                                x1 *= scale;
                                y1 *= scale;
                                x2 *= scale;
                                y2 *= scale;
                                
                                const width = x2 - x1;
                                const height = y2 - y1;
                                
                                console.log(`Grounding Box ${i+1}:`, {
                                    original: bbox.slice(0, 4),
                                    scaled: [x1, y1, x2, y2],
                                    size: [width, height],
                                    label: label
                                });
                                
                                ctx.strokeStyle = color;
                                ctx.lineWidth = 3;
                                ctx.strokeRect(x1, y1, width, height);
                                
                                ctx.fillStyle = color;
                                ctx.font = 'bold 14px Arial';
                                const labelText = label;
                                const textWidth = ctx.measureText(labelText).width;
                                ctx.fillRect(x1, y1 - 25, textWidth + 10, 25);
                                
                                ctx.fillStyle = 'white';
                                ctx.fillText(labelText, x1 + 5, y1 - 7);
                            }
                        });
                    };
                    
                    img.src = imageBase64;
                }
            }
        }).mount('#app');
    </script>
</body>
</html>

# 调试页面工具调用显示功能说明

## 问题修复

修复了以下问题：
1. ✅ 对话历史中现在会显示工具调用信息
2. ✅ 保存测试用例时会显示实际的工具调用
3. ✅ 工具调用信息会被正确保存到对话历史中

## 改进内容

### 1. 对话历史显示增强

对话历史中的助手消息现在会显示：
- **文本内容**：助手的文字回复
- **工具调用**：助手请求的工具调用（如果有）
  - 工具名称
  - 工具参数（JSON格式）

显示效果：
```
🤖 助手:
这是助手的文本回复...

🔧 工具调用:
┌─────────────────────────┐
│ get_weather             │
│ {"city": "北京"}        │
└─────────────────────────┘
```

### 2. 对话历史数据结构

助手消息现在包含可选的 `tool_calls` 字段：

```javascript
{
  role: 'assistant',
  content: '文本内容',
  tool_calls: [  // 可选
    {
      id: 'call_abc123',
      type: 'function',
      function: {
        name: 'get_weather',
        arguments: '{"city": "北京"}'
      }
    }
  ]
}
```

### 3. 保存测试用例界面改进

保存测试用例模态框现在包含：

#### a) 本次模型响应预览
- 显示文本输出（前200字符）
- 显示工具调用摘要
- 如果都没有，显示"无输出"

#### b) 快速填充按钮
- **使用文本输出作为期望** - 将文本输出填充到期望输出字段
  - 只有当有文本输出时才可用
- **使用工具调用作为期望** - 将工具调用填充到期望工具调用字段
  - 只有当有工具调用时才显示

#### c) 预览信息增强
显示内容包括：
- 系统提示词
- 对话历史
- 当前提示词
- 关联工具
- **实际工具调用**（新增）
- 期望输出设置状态
- 期望工具调用设置状态

### 4. 元数据保存

保存测试用例时，会在 `meta_data` 中包含：
- `actual_output` - 实际的文本输出
- `actual_tool_calls` - 实际的工具调用（新增）
- `model_used` - 使用的模型
- `params` - 参数配置
- `response_time` - 响应时间
- `tokens` - Token消耗

## 使用场景示例

### 场景1：测试Function Calling

1. 在调试页面选择一个模型和工具
2. 输入提示词："北京今天天气怎么样？"
3. 模型返回工具调用：`get_weather(city="北京")`
4. 对话历史显示工具调用信息
5. 点击"保存为测试用例"
6. 在模态框中看到：
   - 本次模型响应显示工具调用
   - 快速填充按钮可用
7. 点击"使用工具调用作为期望"
8. 期望工具调用字段自动填充JSON
9. 保存测试用例

### 场景2：多轮对话中的工具调用

1. 第一轮：用户问"北京天气"，助手调用工具
2. 第二轮：用户问"那上海呢"，助手调用工具
3. 对话历史显示两次工具调用
4. 保存测试用例时，完整的对话历史（包括工具调用）会被保存

### 场景3：同时测试文本和工具调用

1. 模型返回文本："我来帮您查询天气"
2. 同时请求工具调用：`get_weather(city="北京")`
3. 对话历史同时显示文本和工具调用
4. 保存时可以同时设置期望输出和期望工具调用

## 技术细节

### 对话历史存储格式

```javascript
conversationHistory = [
  {
    role: 'user',
    content: '北京今天天气怎么样？'
  },
  {
    role: 'assistant',
    content: '我来帮您查询北京的天气信息。',
    tool_calls: [
      {
        id: 'call_abc123',
        type: 'function',
        function: {
          name: 'get_weather',
          arguments: '{"city": "北京", "unit": "celsius"}'
        }
      }
    ]
  }
]
```

### 测试用例保存的数据

```javascript
{
  title: '测试天气查询工具调用',
  prompt: '北京今天天气怎么样？',
  conversation_history: [...],
  expected_output: '我来帮您查询北京的天气信息。',
  expected_tool_calls: [
    {
      function: {
        name: 'get_weather',
        arguments: {
          city: '北京',
          unit: 'celsius'
        }
      }
    }
  ],
  meta_data: {
    actual_output: '我来帮您查询北京的天气信息。',
    actual_tool_calls: [...],
    ...
  }
}
```

## 兼容性

- ✅ 向后兼容：旧的对话历史（只有content字段）仍然正常显示
- ✅ 可选字段：tool_calls 是可选的，没有工具调用时不显示
- ✅ 灵活评分：可以只评估文本、只评估工具调用，或两者都评估

## 测试建议

1. 测试没有工具调用的普通对话
2. 测试只有工具调用没有文本的场景
3. 测试同时有文本和工具调用的场景
4. 测试多轮对话，每轮都有工具调用
5. 验证保存的测试用例数据完整性

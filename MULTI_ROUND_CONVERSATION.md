# 多轮对话测试功能说明

## 功能概述

系统现在支持多轮对话测试，可以测试模型在上下文场景下的表现，例如：
- 上下文理解能力
- 多轮对话的一致性
- 信息记忆与引用
- 复杂对话流程

## 使用方法

### 1. 创建/编辑测试用例

在测试用例页面点击"添加测试用例"或编辑现有用例：

1. 填写基本信息（标题、分类等）
2. 填写系统提示词（可选）
3. **展开"多轮对话历史"区域**
4. 点击"添加用户消息"或"添加助手消息"
5. 输入对话内容
6. 继续添加更多轮对话
7. 最后在"用户提示词"中输入当前轮的问题

### 2. 对话历史操作

- **添加消息**：点击"添加用户消息"或"添加助手消息"按钮
- **删除消息**：点击消息右侧的垃圾桶图标
- **调整顺序**：使用上下箭头调整消息顺序
- **角色切换**：通过下拉菜单切换消息角色（用户/助手）

### 3. 数据格式

对话历史以JSON数组形式存储：

```json
[
  {
    "role": "user",
    "content": "什么是机器学习？"
  },
  {
    "role": "assistant",
    "content": "机器学习是人工智能的一个分支..."
  },
  {
    "role": "user",
    "content": "它有哪些应用场景？"
  }
]
```

## 测试场景示例

### 场景1：上下文记忆测试

**对话历史**：
- 用户：我叫张三
- 助手：你好张三！很高兴认识你。
  
**当前提示**：我叫什么名字？

**期望结果**：模型应该回答"张三"

### 场景2：多步骤任务

**对话历史**：
- 用户：请帮我分析一下上海明天的天气
- 助手：[工具调用] get_weather(location="上海")
- 助手：上海明天多云，温度15-22度

**当前提示**：那我应该穿什么衣服？

**期望结果**：基于天气信息给出穿衣建议

### 场景3：对话状态跟踪

**对话历史**：
- 用户：我想预订一个酒店
- 助手：好的，请问您想去哪个城市？
- 用户：北京
- 助手：明白了。请问入住日期是？

**当前提示**：下周五

**期望结果**：模型应该记住是预订北京的酒店

## 批量测试

多轮对话测试用例会自动应用到批量测试中：
1. 系统会构建完整的消息历史
2. 将对话历史传递给模型
3. 评估模型的最终回答

## 技术细节

### 消息构建顺序

```
1. system_prompt (如果存在)
2. conversation_history (历史对话)
3. prompt (当前用户输入)
```

### 向后兼容性

- 没有对话历史的测试用例会继续按单轮对话处理
- `conversation_history` 字段可选，不填写时等同于单轮测试

## API 集成

### 调用示例

```python
# 单轮测试（无对话历史）
result = await LLMService.call_model(
    model_config=model,
    prompt="你好",
    system_prompt="你是一个助手"
)

# 多轮测试（有对话历史）
result = await LLMService.call_model(
    model_config=model,
    prompt="我叫什么名字？",
    system_prompt="你是一个助手",
    conversation_history=[
        {"role": "user", "content": "我叫张三"},
        {"role": "assistant", "content": "你好张三！"}
    ]
)
```

## 注意事项

1. **顺序很重要**：对话历史应该按时间顺序排列
2. **角色交替**：通常用户和助手消息应该交替出现
3. **内容完整性**：确保历史消息的内容完整，避免上下文断裂
4. **Token限制**：注意对话历史不要过长，避免超出模型的上下文限制

## 评估支持

多轮对话测试支持所有现有的评估功能：
- ✅ 文本相似度评分
- ✅ 工具调用匹配
- ✅ 自定义评估标准
- ✅ 权重配置

## 更新记录

- **2025-10-27**: 初始版本发布
  - 数据库添加 conversation_history 字段
  - 前端UI实现对话历史编辑器
  - 后端服务支持多轮对话
  - 批量测试集成

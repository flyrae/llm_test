# 调试页面多轮对话功能说明

## ✨ 新功能亮点

调试页面现已支持多轮对话测试！您可以与模型进行连续的多轮对话，测试模型的上下文理解和记忆能力。

## 🎯 功能特点

### 1. **自动对话历史记录**
- 每次发送消息后，系统自动保存用户输入和模型回复
- 对话历史以清晰的蓝色（用户）和绿色（助手）卡片展示
- 实时显示对话轮数

### 2. **智能上下文传递**
- 自动将历史对话传递给模型
- 模型可以基于之前的对话内容进行回复
- 支持跨轮次的信息引用和推理

### 3. **灵活的对话控制**
- **继续对话**：在已有对话基础上继续提问
- **清空对话**：单独清空对话历史，开始新对话
- **全部清空**：清空所有内容包括对话历史

### 4. **完整功能支持**
- ✅ 支持流式输出模式
- ✅ 支持工具调用（Function Calling）
- ✅ 支持系统提示词
- ✅ 支持参数调整

## 📖 使用方法

### 基本对话流程

1. **选择模型**：从下拉列表选择要测试的模型
2. **输入第一条消息**：在"用户提示词"框中输入您的问题
3. **点击发送**：系统发送消息并显示回复
4. **继续对话**：对话历史自动显示，继续输入下一个问题
5. **模型回复**：模型会基于完整的对话历史进行回复

### 界面说明

#### 对话历史区域
```
┌─────────────────────────────────┐
│ 💬 对话历史 (2 轮)   [清空对话] │
├─────────────────────────────────┤
│ 👤 用户:                         │
│ 我叫张三                         │
├─────────────────────────────────┤
│ 🤖 助手:                         │
│ 你好张三！很高兴认识你。         │
└─────────────────────────────────┘
```

#### 按钮功能
- **发送/继续**：发送当前输入（如有对话历史则显示"继续"）
- **清空**：清空所有内容
- **清空对话**：仅清空对话历史

## 🎓 使用场景示例

### 场景1：测试记忆能力

**第1轮**：
```
用户: 我最喜欢的颜色是蓝色
助手: 好的，我记住了，你最喜欢的颜色是蓝色。
```

**第2轮**：
```
用户: 我刚才说我喜欢什么颜色？
助手: 你刚才说你最喜欢的颜色是蓝色。
```

### 场景2：多步骤任务

**第1轮**：
```
用户: 请帮我查一下北京明天的天气
助手: [调用get_weather工具]
      北京明天多云，温度10-18度
```

**第2轮**：
```
用户: 那我应该穿什么衣服？
助手: 根据明天北京10-18度的天气，建议您穿长袖衬衫加外套...
```

### 场景3：连续推理

**第1轮**：
```
用户: 1+1等于多少？
助手: 1+1等于2
```

**第2轮**：
```
用户: 那加上3呢？
助手: 2加上3等于5
```

**第3轮**：
```
用户: 再乘以2
助手: 5乘以2等于10
```

## 🔧 技术细节

### 消息格式
对话历史以JSON数组形式传递：
```json
[
  {
    "role": "user",
    "content": "我叫张三"
  },
  {
    "role": "assistant",
    "content": "你好张三！"
  }
]
```

### 消息构建顺序
```
1. system_prompt (如果设置)
2. conversation_history (历史对话)
3. current_prompt (当前输入)
```

### API调用示例
```javascript
{
  "model_id": 1,
  "prompt": "我叫什么名字？",
  "conversation_history": [
    {"role": "user", "content": "我叫张三"},
    {"role": "assistant", "content": "你好张三！"}
  ]
}
```

## 💡 使用技巧

### 1. 测试上下文窗口限制
逐步增加对话轮数，观察模型何时开始遗忘早期信息。

### 2. 测试一致性
在多轮对话中提出矛盾的信息，观察模型如何处理。

### 3. 测试工具调用连续性
在一个对话中多次调用工具，测试模型是否能正确跟踪状态。

### 4. 流式输出
启用流式输出可以实时观察模型的思考过程。

## ⚠️ 注意事项

1. **Token限制**：
   - 对话历史会占用模型的上下文窗口
   - 建议定期清空对话，避免超出限制

2. **成本控制**：
   - 多轮对话会消耗更多tokens
   - 注意查看成本指标

3. **清空操作**：
   - "清空"按钮会清除所有内容
   - "清空对话"只清除历史，保留当前输入

4. **流式模式**：
   - 流式模式下对话历史同样生效
   - 输入框在收到完整回复后自动清空

## 🎨 界面说明

### 视觉设计
- **蓝色卡片**：用户消息（带👤图标）
- **绿色卡片**：助手消息（带🤖图标）
- **滚动区域**：对话历史最多显示264px高度
- **轮数徽章**：实时显示当前对话轮数

### 状态提示
- 有对话历史时，"用户提示词"变为"继续对话"
- 发送按钮文字从"发送"变为"继续"
- 占位符文字也会相应调整

## 📊 与测试用例对比

| 功能 | 调试页面 | 测试用例 |
|------|---------|---------|
| 多轮对话 | ✅ 自动记录 | ✅ 手动配置 |
| 实时测试 | ✅ | ❌ |
| 批量评估 | ❌ | ✅ |
| 保存复用 | ❌ | ✅ |
| 流式输出 | ✅ | ❌ |

## 🚀 快速开始

1. 打开调试页面：http://127.0.0.1:8000/pages/debug.html
2. 选择一个模型
3. 输入："我叫小明"
4. 点击发送，等待回复
5. 继续输入："我叫什么名字？"
6. 观察模型是否正确回答"小明"

成功！您已经完成了第一次多轮对话测试！

## 🆘 常见问题

**Q: 对话历史会自动保存吗？**
A: 对话历史仅保存在当前页面会话中，刷新页面会丢失。

**Q: 可以编辑历史对话吗？**
A: 当前版本不支持编辑，只能清空重新开始。

**Q: 对话历史有长度限制吗？**
A: 前端无限制，但受模型上下文窗口限制（通常4k-128k tokens）。

**Q: 如何保存有价值的对话？**
A: 可以将对话内容复制到测试用例中保存和复用。

**Q: 流式模式下对话历史如何更新？**
A: 等待流式输出完成后，自动添加到对话历史。

## 🔗 相关文档

- 完整对话功能说明：`MULTI_ROUND_CONVERSATION.md`
- 快速开始指南：`QUICK_START_MULTI_ROUND.md`
- API文档：查看 `backend/app/api/debug.py`

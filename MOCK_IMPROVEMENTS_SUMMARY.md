# MockåŠŸèƒ½æ”¹è¿›å®Œæˆæ€»ç»“

## âœ… å·²å®Œæˆçš„æ”¹è¿›

### 1. **åˆ›å»ºå®Œæ•´çš„ Agent è®­ç»ƒæœåŠ¡** âœ“
- æ–‡ä»¶: `backend/app/services/agent_service.py`
- åŠŸèƒ½: å®ç°å®Œæ•´çš„å·¥å…·è°ƒç”¨é—­ç¯
  - æ¨¡å‹è°ƒç”¨ â†’ å·¥å…·è°ƒç”¨æ£€æµ‹ â†’ å·¥å…·æ‰§è¡Œï¼ˆMock/çœŸå®ï¼‰
  - ç»“æœåé¦ˆåˆ°å¯¹è¯å†å² â†’ æ¨¡å‹ç»§ç»­æ¨ç† â†’ æœ€ç»ˆç­”æ¡ˆ
  - æ”¯æŒæœ€å¤š5è½®è¿­ä»£ï¼Œé˜²æ­¢æ— é™å¾ªç¯
  - è¯¦ç»†çš„æ—¥å¿—è®°å½•å’ŒæŒ‡æ ‡ç»Ÿè®¡

### 2. **ä¿®å¤ Debug API æ”¯æŒå¤šè½®å·¥å…·è°ƒç”¨** âœ“
- æ–‡ä»¶: `backend/app/api/debug.py`
- æ”¹è¿›:
  - æ–°å¢ `use_agent` å‚æ•°ï¼ˆé»˜è®¤Trueï¼‰
  - æ–°å¢ `max_iterations` å‚æ•°ï¼ˆé»˜è®¤5ï¼‰
  - é›†æˆ AgentServiceï¼Œè‡ªåŠ¨é€‰æ‹©å•æ¬¡è°ƒç”¨æˆ–Agentæ¨¡å¼
  - è¿”å›å®Œæ•´çš„ `tool_call_history` å’Œ `conversation_history`
  - å‘åå…¼å®¹æ—§ç‰ˆAPI

### 3. **ç»Ÿä¸€ Mock æ§åˆ¶é€»è¾‘** âœ“
- æ–‡ä»¶: `backend/app/api/batch.py`
- æ”¹è¿›:
  - è¯»å–æµ‹è¯•ç”¨ä¾‹çš„ `use_mock` å­—æ®µ
  - æœ‰å·¥å…·å®šä¹‰æ—¶è‡ªåŠ¨ä½¿ç”¨ Agent æ¨¡å¼
  - å°† Mock é…ç½®ä¼ é€’ç»™ AgentService
  - å®Œæ•´çš„å·¥å…·è°ƒç”¨å†å²è®°å½•

### 4. **å¢å¼ºè¯„ä¼°æœåŠ¡** âœ“
- æ–‡ä»¶: `backend/app/services/evaluation_service.py`
- æ–°å¢åŠŸèƒ½:
  - `evaluate_tool_usage_flow()` æ–¹æ³•
  - è¯„ä¼°ç»´åº¦:
    * æ˜¯å¦æ‰§è¡Œå·¥å…·è°ƒç”¨ï¼ˆ20åˆ†ï¼‰
    * å·¥å…·ç»“æœæ˜¯å¦åœ¨å¯¹è¯å†å²ï¼ˆ20åˆ†ï¼‰
    * æœ€ç»ˆç­”æ¡ˆæ˜¯å¦ä½¿ç”¨å·¥å…·æ•°æ®ï¼ˆ30åˆ†ï¼‰
    * å·¥å…·è°ƒç”¨é¡ºåºåˆç†æ€§ï¼ˆ30åˆ†ï¼‰
  - æ›´æ–°æƒé‡é…ç½®ï¼š`tool_calls: 50, text_similarity: 20, tool_flow: 20, custom: 10`
  - æ”¯æŒä¼ å…¥ `conversation_history` å’Œ `tool_call_history`

### 5. **æ·»åŠ  Mock é…ç½®éªŒè¯å’Œé¢„è®¾** âœ“
- æ–‡ä»¶: `backend/app/services/mock_tool_executor.py`
- æ–°å¢:
  - `validate_mock_config()` æ–¹æ³•ï¼šéªŒè¯é…ç½®åˆæ³•æ€§
  - `PRESET_TEMPLATES`ï¼š3ä¸ªé¢„è®¾æ¨¡æ¿
    * `simple_success`: ç®€å•æˆåŠŸå“åº”
    * `simple_error`: ç®€å•é”™è¯¯å“åº”
    * `api_simulation`: APIæ¨¡æ‹Ÿï¼ˆæ”¯æŒåŠ¨æ€å‚æ•°ï¼‰
  - `list_preset_templates()`: åˆ—å‡ºæ‰€æœ‰é¢„è®¾
  - `get_preset_template()`: è·å–æŒ‡å®šé¢„è®¾

- æ–‡ä»¶: `backend/app/api/tools.py`
- æ–°å¢APIç«¯ç‚¹:
  - `GET /api/tools/mock/presets` - è·å–Mocké¢„è®¾æ¨¡æ¿
  - `POST /api/tools/mock/validate` - éªŒè¯Mocké…ç½®

## ğŸ“‹ æ ¸å¿ƒæ”¹è¿›ç‚¹

### é—®é¢˜1: ç¼ºå°‘å®Œæ•´çš„ Agent è®­ç»ƒæµç¨‹ âœ“ å·²è§£å†³
**è§£å†³æ–¹æ¡ˆ:**
```python
# æ–°çš„æµç¨‹
æ¨¡å‹ â†’ å·¥å…·è°ƒç”¨ â†’ Mockæ‰§è¡Œ â†’ ç»“æœæ·»åŠ åˆ°å†å² â†’ æ¨¡å‹ç»§ç»­æ¨ç† â†’ æœ€ç»ˆç­”æ¡ˆ
           â†‘________â†“ (å¯å¾ªç¯å¤šæ¬¡)
```

### é—®é¢˜2: Mock æ§åˆ¶é€»è¾‘åˆ†æ•£ âœ“ å·²è§£å†³
**è§£å†³æ–¹æ¡ˆ:**
- æµ‹è¯•ç”¨ä¾‹çš„ `use_mock` å­—æ®µç°åœ¨çœŸæ­£ç”Ÿæ•ˆ
- ç»Ÿä¸€é€šè¿‡ AgentService å¤„ç†
- Debug API å’Œ Batch API éƒ½æ”¯æŒ

### é—®é¢˜3: è¯„ä¼°æŒ‡æ ‡ä¸å®Œæ•´ âœ“ å·²è§£å†³
**è§£å†³æ–¹æ¡ˆ:**
- æ–°å¢å·¥å…·ä½¿ç”¨æµç¨‹è¯„ä¼°
- æ£€æŸ¥å·¥å…·ç»“æœæ˜¯å¦è¢«å®é™…ä½¿ç”¨
- è¯„ä¼°å·¥å…·è°ƒç”¨çš„åˆç†æ€§

### é—®é¢˜4: Mocké…ç½®å¤æ‚ âœ“ å·²è§£å†³
**è§£å†³æ–¹æ¡ˆ:**
- æä¾›3ä¸ªå¼€ç®±å³ç”¨çš„é¢„è®¾æ¨¡æ¿
- æä¾›é…ç½®éªŒè¯API
- è¯¦ç»†çš„é”™è¯¯æç¤º

## ğŸ¯ ä½¿ç”¨ç¤ºä¾‹

### 1. Debug API - Agentæ¨¡å¼
```bash
POST /api/debug/chat
{
  "model_id": 1,
  "content": "å¸®æˆ‘æŸ¥è¯¢åŒ—äº¬çš„å¤©æ°”",
  "tool_ids": [1, 2],
  "use_mock": true,      # ä½¿ç”¨Mockæ‰§è¡Œ
  "use_agent": true,     # å¯ç”¨Agentæ¨¡å¼ï¼ˆé»˜è®¤ï¼‰
  "max_iterations": 5    # æœ€å¤§è¿­ä»£æ¬¡æ•°
}
```

**è¿”å›:**
```json
{
  "output": "æ ¹æ®æŸ¥è¯¢ç»“æœï¼ŒåŒ—äº¬ä»Šå¤©æ™´å¤©ï¼Œæ¸©åº¦25åº¦...",
  "metrics": {
    "total_iterations": 2,
    "total_tokens": 1250,
    "estimated_cost": 0.00125
  },
  "tool_call_history": [
    {
      "iteration": 1,
      "tool_name": "get_weather",
      "arguments": {"city": "åŒ—äº¬"},
      "result": {"temperature": 25, "weather": "æ™´å¤©"}
    }
  ],
  "conversation_history": [...]
}
```

### 2. è·å–Mocké¢„è®¾æ¨¡æ¿
```bash
GET /api/tools/mock/presets
```

**è¿”å›:**
```json
{
  "presets": [
    {
      "name": "simple_success",
      "description": "ç®€å•æˆåŠŸå“åº” - è¿”å›å›ºå®šçš„æˆåŠŸæ¶ˆæ¯",
      "template": {
        "enabled": true,
        "response_type": "static",
        "static_response": {
          "success": true,
          "message": "æ“ä½œæˆåŠŸ"
        }
      }
    }
  ]
}
```

### 3. éªŒè¯Mocké…ç½®
```bash
POST /api/tools/mock/validate
{
  "mock_config": {
    "enabled": true,
    "response_type": "static",
    "static_response": {"success": true}
  }
}
```

## ğŸ“Š è¯„ä¼°æŒ‡æ ‡å¯¹æ¯”

### æ—§ç‰ˆè¯„ä¼°
- âœ… å·¥å…·è°ƒç”¨åç§°åŒ¹é…ï¼ˆ70%æƒé‡ï¼‰
- âœ… æ–‡æœ¬ç›¸ä¼¼åº¦ï¼ˆ20%æƒé‡ï¼‰
- âœ… è‡ªå®šä¹‰æ ‡å‡†ï¼ˆ10%æƒé‡ï¼‰

### æ–°ç‰ˆè¯„ä¼°
- âœ… å·¥å…·è°ƒç”¨å‡†ç¡®æ€§ï¼ˆ50%æƒé‡ï¼‰
- âœ… å·¥å…·ä½¿ç”¨æµç¨‹ï¼ˆ20%æƒé‡ï¼‰**æ–°å¢**
- âœ… æ–‡æœ¬ç›¸ä¼¼åº¦ï¼ˆ20%æƒé‡ï¼‰
- âœ… è‡ªå®šä¹‰æ ‡å‡†ï¼ˆ10%æƒé‡ï¼‰

## âš ï¸ æ³¨æ„äº‹é¡¹

1. **å‘åå…¼å®¹**: æ‰€æœ‰æ”¹åŠ¨ä¿æŒå‘åå…¼å®¹ï¼Œæ—§çš„APIè°ƒç”¨æ–¹å¼ä»ç„¶æœ‰æ•ˆ
2. **é»˜è®¤è¡Œä¸º**: æœ‰å·¥å…·æ—¶é»˜è®¤å¯ç”¨Agentæ¨¡å¼ï¼Œæ— å·¥å…·æ—¶ä½¿ç”¨å•æ¬¡è°ƒç”¨
3. **æµå¼æ¨¡å¼**: æµå¼è¾“å‡ºæš‚ä¸æ”¯æŒAgentæ¨¡å¼ï¼ˆéœ€è¦ç­‰å¾…å·¥å…·æ‰§è¡Œå®Œæˆï¼‰
4. **çœŸå®å·¥å…·æ‰§è¡Œ**: ç›®å‰ä»…å®ç°äº†Mockæ‰§è¡Œï¼ŒçœŸå®å·¥å…·æ‰§è¡Œéœ€è¦åç»­å¼€å‘

## ğŸš€ åç»­å»ºè®®

### å‰ç«¯æ”¹è¿›ï¼ˆå¾…å®ç°ï¼‰
1. åœ¨ debug.html ä¸­å¯è§†åŒ–å±•ç¤ºå·¥å…·è°ƒç”¨é“¾è·¯
2. æ·»åŠ  Agent æ¨¡å¼å¼€å…³å’Œæœ€å¤§è¿­ä»£æ¬¡æ•°è®¾ç½®
3. åœ¨å·¥å…·é¡µé¢é›†æˆMocké¢„è®¾æ¨¡æ¿é€‰æ‹©å™¨
4. å±•ç¤ºå·¥å…·ä½¿ç”¨æµç¨‹è¯„ä¼°çš„è¯¦ç»†ç»“æœ

### åŠŸèƒ½æ‰©å±•
1. å®ç°çœŸå®å·¥å…·æ‰§è¡Œå™¨ï¼ˆRealToolExecutorï¼‰
2. æ”¯æŒæµå¼æ¨¡å¼ä¸‹çš„Agentè°ƒç”¨
3. æ·»åŠ æ›´å¤šMocké¢„è®¾æ¨¡æ¿
4. å·¥å…·è°ƒç”¨å¯è§†åŒ–å›¾è¡¨

## ğŸ“ æµ‹è¯•å»ºè®®

1. **æµ‹è¯•Agentæµç¨‹**:
   - åˆ›å»ºä¸€ä¸ªå·¥å…·å®šä¹‰ï¼ˆå¸¦Mocké…ç½®ï¼‰
   - åˆ›å»ºæµ‹è¯•ç”¨ä¾‹ï¼ˆè®¾ç½® use_mock=trueï¼‰
   - è¿è¡Œæ‰¹é‡æµ‹è¯•ï¼ŒæŸ¥çœ‹å·¥å…·è°ƒç”¨å†å²

2. **æµ‹è¯•è¯„ä¼°å¢å¼º**:
   - æŸ¥çœ‹æµ‹è¯•ç»“æœçš„ metrics.evaluation.tool_flow å­—æ®µ
   - éªŒè¯æ˜¯å¦æ­£ç¡®è¯†åˆ«å·¥å…·ç»“æœçš„ä½¿ç”¨æƒ…å†µ

3. **æµ‹è¯•Mocké¢„è®¾**:
   - è®¿é—® `/api/tools/mock/presets` è·å–æ¨¡æ¿
   - ä½¿ç”¨é¢„è®¾æ¨¡æ¿åˆ›å»ºå·¥å…·
   - éªŒè¯Mockæ‰§è¡Œæ˜¯å¦æ­£å¸¸

## ğŸ“– ç›¸å…³æ–‡æ¡£

- AgentæœåŠ¡: `backend/app/services/agent_service.py`
- Mockæ‰§è¡Œå™¨: `backend/app/services/mock_tool_executor.py`
- è¯„ä¼°æœåŠ¡: `backend/app/services/evaluation_service.py`
- Debug API: `backend/app/api/debug.py`
- Batch API: `backend/app/api/batch.py`
- Tools API: `backend/app/api/tools.py`
